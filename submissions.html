<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HolDex Admin | Submissions</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { background-color: #0f0502; color: #ffedd5; font-family: 'JetBrains Mono', monospace; }
        .card { background: #1a0a05; border: 1px solid #451a03; border-radius: 8px; padding: 16px; margin-bottom: 16px; }
        .btn { padding: 8px 16px; border-radius: 6px; font-weight: bold; cursor: pointer; transition: all 0.2s; }
        .btn-green { background: #14532d; color: #4ade80; border: 1px solid #22c55e; }
        .btn-green:hover { background: #166534; }
        .btn-red { background: #450a0a; color: #fca5a5; border: 1px solid #ef4444; }
        .btn-red:hover { background: #7f1d1d; }
        .btn-blue { background: #1e3a8a; color: #93c5fd; border: 1px solid #3b82f6; }
        .btn-blue:hover { background: #1e40af; }
        .badge { font-size: 10px; padding: 2px 6px; border-radius: 4px; text-transform: uppercase; }
        .badge-pending { background: #422006; color: #fdba74; border: 1px solid #f97316; }
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.9); display: flex; align-items: center; justify-content: center; z-index: 50; display: none; }
        .modal.open { display: flex; }
    </style>
</head>
<body class="p-6 max-w-5xl mx-auto">

    <div class="flex justify-between items-center mb-8 border-b border-[#451a03] pb-4">
        <h1 class="text-2xl font-bold text-[#ea580c] flex items-center gap-2">
            <i data-lucide="shield" width="24"></i> Admin Command
        </h1>
        <div class="flex gap-4">
            <button onclick="logout()" class="text-[#9a3412] hover:text-[#ef4444] text-sm">Logout</button>
        </div>
    </div>

    <!-- AUTH MODAL -->
    <div id="auth-modal" class="modal open">
        <div class="bg-[#1a0a05] border border-[#ea580c] p-8 rounded-xl w-full max-w-sm text-center">
            <h2 class="text-xl font-bold text-white mb-4">Admin Access</h2>
            <input type="password" id="admin-pass" placeholder="Enter Key..." class="w-full bg-[#0f0502] border border-[#451a03] p-3 rounded text-white mb-4 outline-none focus:border-[#ea580c]">
            <button onclick="login()" class="w-full btn btn-green">Unlock Terminal</button>
        </div>
    </div>

    <div id="dashboard" class="hidden space-y-8">
        <!-- STATS ROW -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <div class="card text-center">
                <div class="text-[#9a3412] text-xs uppercase mb-1">Pending</div>
                <div class="text-2xl font-bold text-[#fb923c]" id="count-pending">0</div>
            </div>
            <div class="card text-center">
                <div class="text-[#9a3412] text-xs uppercase mb-1">Total History</div>
                <div class="text-2xl font-bold text-white" id="count-total">0</div>
            </div>
             <!-- NEW: DB TOOLS -->
            <div class="card col-span-2 flex items-center justify-between">
                <div>
                    <div class="text-[#ea580c] font-bold mb-1"><i data-lucide="database" width="16" class="inline"></i> DB Tools</div>
                    <div class="text-[10px] text-[#9a3412]">Backup & Restore Updates</div>
                </div>
                <div class="flex gap-2">
                    <button onclick="downloadBackup()" class="btn btn-blue text-xs flex items-center gap-2"><i data-lucide="download" width="14"></i> Backup</button>
                    <label class="btn btn-green text-xs flex items-center gap-2 cursor-pointer">
                        <i data-lucide="upload" width="14"></i> Restore
                        <input type="file" id="restore-file" accept=".json" class="hidden" onchange="handleRestore(this)">
                    </label>
                </div>
            </div>
        </div>

        <!-- TABS -->
        <div class="flex gap-4 border-b border-[#451a03]">
            <button onclick="switchTab('pending')" id="tab-pending" class="px-4 py-2 text-[#fb923c] border-b-2 border-[#ea580c]">Pending Queue</button>
            <button onclick="switchTab('history')" id="tab-history" class="px-4 py-2 text-[#9a3412]">History Log</button>
        </div>

        <!-- CONTENT -->
        <div id="list-container" class="space-y-4">
            <!-- Items injected here -->
            <div class="text-center py-12 text-[#9a3412]">Loading...</div>
        </div>
    </div>

    <script>
        const API_URL = 'https://asdev-backend.onrender.com';
        let AUTH_KEY = localStorage.getItem('holdex_admin_key') || '';
        let currentTab = 'pending';

        function init() {
            if (AUTH_KEY) {
                document.getElementById('auth-modal').classList.remove('open');
                document.getElementById('dashboard').classList.remove('hidden');
                fetchUpdates();
            }
            lucide.createIcons();
        }

        function login() {
            const key = document.getElementById('admin-pass').value;
            if (!key) return alert("Enter key");
            AUTH_KEY = key;
            localStorage.setItem('holdex_admin_key', key);
            init();
        }

        function logout() {
            localStorage.removeItem('holdex_admin_key');
            location.reload();
        }

        function switchTab(tab) {
            currentTab = tab;
            document.getElementById('tab-pending').className = tab === 'pending' ? "px-4 py-2 text-[#fb923c] border-b-2 border-[#ea580c]" : "px-4 py-2 text-[#9a3412]";
            document.getElementById('tab-history').className = tab === 'history' ? "px-4 py-2 text-[#fb923c] border-b-2 border-[#ea580c]" : "px-4 py-2 text-[#9a3412]";
            fetchUpdates();
        }

        async function fetchUpdates() {
            const container = document.getElementById('list-container');
            container.innerHTML = '<div class="text-center py-12 text-[#ea580c] animate-pulse">Fetching Data...</div>';
            
            try {
                const res = await fetch(`${API_URL}/api/admin/updates?type=${currentTab}`, {
                    headers: { 'x-admin-auth': AUTH_KEY }
                });
                const data = await res.json();
                
                if (!data.success) {
                    if (data.error === 'Unauthorized') {
                        logout();
                        return alert("Invalid Key");
                    }
                    return alert("Error: " + data.error);
                }

                renderList(data.updates);
                
                // Update stats mostly for visual
                if (currentTab === 'pending') {
                    document.getElementById('count-pending').innerText = data.updates.length;
                }

            } catch (e) {
                container.innerHTML = `<div class="text-center text-red-500">Connection Error</div>`;
            }
        }

        function renderList(items) {
            const container = document.getElementById('list-container');
            if (items.length === 0) {
                container.innerHTML = '<div class="text-center py-12 text-[#9a3412]">No records found.</div>';
                return;
            }

            container.innerHTML = items.map(item => `
                <div class="card flex flex-col md:flex-row gap-6">
                    <div class="w-32 h-32 bg-black border border-[#451a03] rounded shrink-0 overflow-hidden relative group">
                        <img src="${item.image || 'https://placehold.co/100'}" class="w-full h-full object-cover opacity-50">
                        <div class="absolute inset-0 flex items-center justify-center font-bold text-xs text-white bg-black/50">${item.ticker || '???'}</div>
                    </div>
                    
                    <div class="flex-1 space-y-3">
                        <div class="flex justify-between items-start">
                            <div>
                                <h3 class="font-bold text-white text-lg">${item.mint}</h3>
                                <div class="text-xs text-[#9a3412] font-mono mt-1">
                                    Submitted: ${new Date(Number(item.submittedat || item.submittedAt)).toLocaleString()}
                                </div>
                            </div>
                            <span class="badge badge-pending">${item.status}</span>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-2 text-xs">
                            <div class="bg-[#0f0502] p-2 rounded border border-[#451a03]">
                                <span class="text-[#9a3412]">Twitter:</span> <a href="${item.twitter}" target="_blank" class="text-[#fb923c] hover:underline truncate block">${item.twitter || '-'}</a>
                            </div>
                            <div class="bg-[#0f0502] p-2 rounded border border-[#451a03]">
                                <span class="text-[#9a3412]">Web:</span> <a href="${item.website}" target="_blank" class="text-[#fb923c] hover:underline truncate block">${item.website || '-'}</a>
                            </div>
                        </div>
                        
                        <div class="bg-[#0f0502] p-3 rounded border border-[#451a03] text-xs text-[#d1d5db]">
                            <span class="text-[#9a3412] block mb-1">Description:</span>
                            ${item.description || 'No description provided.'}
                        </div>
                    </div>

                    <div class="flex flex-col gap-2 justify-center min-w-[120px]">
                        ${currentTab === 'pending' ? `
                            <button onclick="approve(${item.id})" class="btn btn-green w-full">Approve</button>
                            <button onclick="reject(${item.id})" class="btn btn-red w-full">Reject</button>
                        ` : `
                            <div class="text-center text-xs text-[#9a3412]">Action Taken</div>
                        `}
                    </div>
                </div>
            `).join('');
            lucide.createIcons();
        }

        async function approve(id) {
            if (!confirm("Approve this update? It will go live immediately.")) return;
            try {
                const res = await fetch(`${API_URL}/api/admin/approve-update`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'x-admin-auth': AUTH_KEY },
                    body: JSON.stringify({ id })
                });
                const data = await res.json();
                if (data.success) fetchUpdates();
                else alert(data.error);
            } catch (e) { alert("Network Error"); }
        }

        async function reject(id) {
            if (!confirm("Reject this update?")) return;
            try {
                const res = await fetch(`${API_URL}/api/admin/reject-update`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'x-admin-auth': AUTH_KEY },
                    body: JSON.stringify({ id })
                });
                const data = await res.json();
                if (data.success) fetchUpdates();
                else alert(data.error);
            } catch (e) { alert("Network Error"); }
        }

        // --- NEW: BACKUP & RESTORE FUNCTIONS ---
        
        async function downloadBackup() {
            try {
                const res = await fetch(`${API_URL}/api/admin/backup/updates`, {
                    headers: { 'x-admin-auth': AUTH_KEY }
                });
                
                if (!res.ok) throw new Error("Backup Failed");
                
                const blob = await res.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `holdex_updates_backup_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
            } catch (e) {
                alert("Backup Error: " + e.message);
            }
        }

        function handleRestore(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const json = JSON.parse(e.target.result);
                    
                    // Handle both direct array or wrapped object format
                    const updates = Array.isArray(json) ? json : (json.data || []);
                    
                    if (updates.length === 0) return alert("No updates found in file.");
                    
                    if (!confirm(`Restore ${updates.length} updates? \n(Duplicates will be skipped)`)) {
                        input.value = ''; // Reset
                        return;
                    }

                    const res = await fetch(`${API_URL}/api/admin/restore/updates`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'x-admin-auth': AUTH_KEY },
                        body: JSON.stringify({ updates })
                    });
                    
                    const data = await res.json();
                    if (data.success) {
                        alert(data.message);
                        fetchUpdates();
                    } else {
                        alert("Restore Failed: " + data.error);
                    }
                } catch (err) {
                    alert("Invalid JSON File");
                    console.error(err);
                } finally {
                    input.value = ''; // Reset input so same file can be selected again if needed
                }
            };
            reader.readAsText(file);
        }

        init();
    </script>
</body>
</html>
