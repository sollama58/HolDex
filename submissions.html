<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HolDex | Admin Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { background-color: #0f0502; color: #ffedd5; font-family: 'JetBrains Mono', monospace; }
        .card { background: #1a0a05; border: 1px solid #451a03; border-radius: 8px; padding: 16px; margin-bottom: 16px; }
        .btn { padding: 8px 16px; border-radius: 6px; font-weight: bold; cursor: pointer; transition: all 0.2s; white-space: nowrap; display: inline-flex; align-items: center; justify-content: center; gap: 6px; }
        .btn-green { background: #14532d; color: #4ade80; border: 1px solid #22c55e; }
        .btn-green:hover { background: #166534; }
        .btn-red { background: #450a0a; color: #fca5a5; border: 1px solid #ef4444; }
        .btn-red:hover { background: #7f1d1d; }
        .btn-blue { background: #1e3a8a; color: #93c5fd; border: 1px solid #3b82f6; }
        .btn-blue:hover { background: #1e40af; }
        .btn-orange { background: #431407; color: #fdba74; border: 1px solid #f97316; }
        .btn-orange:hover { background: #7c2d12; }
        .badge { font-size: 10px; padding: 2px 6px; border-radius: 4px; text-transform: uppercase; }
        .badge-pending { background: #422006; color: #fdba74; border: 1px solid #f97316; }
        .form-input { background: #0f0502; border: 1px solid #7c2d12; color: #fb923c; padding: 8px; border-radius: 6px; width: 100%; outline: none; transition: border-color 0.2s; }
        .form-input:focus { border-color: #ea580c; }
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.9); display: flex; align-items: center; justify-content: center; z-index: 50; display: none; }
        .modal.open { display: flex; }
        .nav-tab { padding: 10px 20px; color: #9a3412; font-weight: bold; border-bottom: 2px solid transparent; cursor: pointer; }
        .nav-tab.active { color: #ea580c; border-bottom-color: #ea580c; }
        .hidden { display: none; }
    </style>
</head>
<body class="p-6 max-w-5xl mx-auto">

    <div class="flex justify-between items-center mb-8 border-b border-[#451a03] pb-4">
        <h1 class="text-2xl font-bold text-[#ea580c] flex items-center gap-2">
            <i data-lucide="shield" width="24"></i> Admin Command
        </h1>
        <div class="flex gap-4">
            <button onclick="logout()" class="text-[#9a3412] hover:text-[#ef4444] text-sm">Logout</button>
        </div>
    </div>

    <!-- AUTH MODAL -->
    <div id="auth-modal" class="modal open">
        <div class="bg-[#1a0a05] border border-[#ea580c] p-8 rounded-xl w-full max-w-sm text-center">
            <h2 class="text-xl font-bold text-white mb-4">Admin Access</h2>
            <input type="password" id="admin-pass" placeholder="Enter Key..." class="w-full bg-[#0f0502] border border-[#451a03] p-3 rounded text-white mb-4 outline-none focus:border-[#ea580c]">
            <button onclick="login()" class="w-full btn btn-green">Unlock Terminal</button>
        </div>
    </div>

    <div id="dashboard" class="hidden space-y-8">
        <!-- STATS ROW -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <div class="card text-center">
                <div class="text-[#9a3412] text-xs uppercase mb-1">Pending</div>
                <div class="text-2xl font-bold text-[#fb923c]" id="count-pending">0</div>
            </div>
            <div class="card text-center">
                <div class="text-[#9a3412] text-xs uppercase mb-1">Total History</div>
                <div class="text-2xl font-bold text-white" id="count-total">0</div>
            </div>
             <!-- DB TOOLS -->
            <div class="card col-span-2 flex items-center justify-between">
                <div>
                    <div class="text-[#ea580c] font-bold mb-1 text-sm"><i data-lucide="database" width="14" class="inline"></i> Updates DB</div>
                    <div class="text-[10px] text-[#9a3412]">Backup & Restore</div>
                </div>
                <div class="flex gap-2">
                    <button onclick="downloadBackup()" class="btn btn-blue text-xs"><i data-lucide="download" width="14"></i> Backup</button>
                    <label class="btn btn-green text-xs cursor-pointer">
                        <i data-lucide="upload" width="14"></i> Restore
                        <input type="file" id="restore-file" accept=".json" class="hidden" onchange="handleRestore(this)">
                    </label>
                </div>
            </div>
        </div>

        <!-- TABS -->
        <div class="flex gap-4 border-b border-[#451a03] mb-6">
            <button onclick="switchTab('pending')" id="tab-pending" class="nav-tab active">Pending Queue</button>
            <button onclick="switchTab('history')" id="tab-history" class="nav-tab">History Log</button>
            <button onclick="switchTab('manage')" id="tab-manage" class="nav-tab">Manage Token</button>
        </div>

        <!-- VIEW: LIST (Pending & History) -->
        <div id="view-list" class="space-y-4">
            <div id="list-container" class="space-y-4">
                <div class="text-center py-12 text-[#9a3412]">Loading...</div>
            </div>
        </div>

        <!-- VIEW: MANAGE TOKEN -->
        <div id="view-manage" class="hidden">
            <div class="card max-w-2xl mx-auto p-8">
                <h3 class="text-xl font-bold text-white mb-6 flex items-center gap-2"><i data-lucide="edit" width="20"></i> Edit or Delete Token</h3>
                
                <div class="flex gap-4 mb-6">
                    <input type="text" id="manage-mint" class="form-input" placeholder="Enter Token Mint Address...">
                    <button onclick="loadToken()" class="btn btn-blue">Load</button>
                </div>

                <div id="manage-form" class="hidden space-y-4 border-t border-[#451a03] pt-6">
                    <div class="grid grid-cols-2 gap-4">
                         <div><label class="text-xs text-[#9a3412] uppercase font-bold block mb-1">Ticker</label><input type="text" id="edit-ticker" class="form-input opacity-50 cursor-not-allowed" readonly></div>
                         <div><label class="text-xs text-[#9a3412] uppercase font-bold block mb-1">Holders</label><input type="text" id="edit-holders" class="form-input opacity-50 cursor-not-allowed" readonly value="0"></div>
                    </div>
                    
                    <div class="grid grid-cols-3 gap-4">
                        <div><label class="text-xs text-[#9a3412] uppercase font-bold block mb-1">Twitter</label><input type="text" id="edit-twitter" class="form-input"></div>
                        <div><label class="text-xs text-[#9a3412] uppercase font-bold block mb-1">Website</label><input type="text" id="edit-website" class="form-input"></div>
                        <div><label class="text-xs text-[#9a3412] uppercase font-bold block mb-1">Telegram</label><input type="text" id="edit-telegram" class="form-input"></div>
                    </div>
                    
                    <div><label class="text-xs text-[#9a3412] uppercase font-bold block mb-1">Banner URL</label><input type="text" id="edit-banner" class="form-input"></div>
                    
                    <div>
                        <label class="text-xs text-[#9a3412] uppercase font-bold block mb-1">Description (Max 250)</label>
                        <textarea id="edit-description" class="form-input h-24 resize-none" maxlength="250"></textarea>
                    </div>

                    <div class="border-t border-[#451a03] pt-6 mt-6">
                        <div class="flex items-center justify-between mb-4 bg-[#0f0502] p-3 rounded border border-[#451a03]">
                            <span class="text-[#fb923c] font-bold text-sm">Refresh K-Score</span>
                            <button onclick="refreshKScore()" class="btn btn-orange text-xs">
                                <i data-lucide="zap" width="14"></i> Force Recalculate
                            </button>
                        </div>
                        
                        <div class="flex justify-between items-center mt-8">
                            <button onclick="deleteToken()" class="btn btn-red text-xs">
                                <i data-lucide="trash-2" width="14"></i> Delete Token & History
                            </button>
                            <button onclick="saveToken()" class="btn btn-green text-xs">
                                <i data-lucide="save" width="14"></i> Save Changes
                            </button>
                        </div>
                        <p class="text-[10px] text-red-900/50 text-center mt-4 uppercase font-bold">Warning: Deletion is permanent.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'https://asdev-backend.onrender.com';
        let AUTH_KEY = localStorage.getItem('holdex_admin_key') || '';
        let currentTab = 'pending';

        function init() {
            if (AUTH_KEY) {
                document.getElementById('auth-modal').classList.remove('open');
                document.getElementById('dashboard').classList.remove('hidden');
                if (currentTab !== 'manage') fetchUpdates();
            }
            lucide.createIcons();
        }

        function login() {
            const key = document.getElementById('admin-pass').value;
            if (!key) return alert("Enter key");
            AUTH_KEY = key;
            localStorage.setItem('holdex_admin_key', key);
            init();
        }

        function logout() {
            localStorage.removeItem('holdex_admin_key');
            location.reload();
        }

        function switchTab(tab) {
            currentTab = tab;
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            document.getElementById(`tab-${tab}`).classList.add('active');

            const listView = document.getElementById('view-list');
            const manageView = document.getElementById('view-manage');

            if (tab === 'manage') {
                listView.classList.add('hidden');
                manageView.classList.remove('hidden');
            } else {
                manageView.classList.add('hidden');
                listView.classList.remove('hidden');
                fetchUpdates();
            }
        }

        async function fetchUpdates() {
            const container = document.getElementById('list-container');
            container.innerHTML = '<div class="text-center py-12 text-[#ea580c] animate-pulse">Fetching Data...</div>';
            
            try {
                const res = await fetch(`${API_URL}/api/admin/updates?type=${currentTab}`, {
                    headers: { 'x-admin-auth': AUTH_KEY }
                });
                const data = await res.json();
                
                if (!data.success) {
                    if (data.error === 'Unauthorized') { logout(); return alert("Invalid Key"); }
                    return alert("Error: " + data.error);
                }

                renderList(data.updates);
                if (currentTab === 'pending') document.getElementById('count-pending').innerText = data.updates.length;

            } catch (e) { container.innerHTML = `<div class="text-center text-red-500">Connection Error</div>`; }
        }

        function renderList(items) {
            const container = document.getElementById('list-container');
            if (items.length === 0) { container.innerHTML = '<div class="text-center py-12 text-[#9a3412]">No records found.</div>'; return; }

            container.innerHTML = items.map(item => `
                <div class="card flex flex-col md:flex-row gap-6">
                    <div class="w-32 h-32 bg-black border border-[#451a03] rounded shrink-0 overflow-hidden relative group">
                        <img src="${item.image || 'https://placehold.co/100'}" class="w-full h-full object-cover opacity-50">
                        <div class="absolute inset-0 flex items-center justify-center font-bold text-xs text-white bg-black/50">${item.ticker || '???'}</div>
                    </div>
                    <div class="flex-1 space-y-3">
                        <div class="flex justify-between items-start">
                            <div>
                                <h3 class="font-bold text-white text-lg">${item.mint}</h3>
                                <div class="text-xs text-[#9a3412] font-mono mt-1">Submitted: ${new Date(Number(item.submittedat || item.submittedAt)).toLocaleString()}</div>
                            </div>
                            <span class="badge badge-pending">${item.status}</span>
                        </div>
                        <div class="grid grid-cols-2 gap-2 text-xs">
                            <div class="bg-[#0f0502] p-2 rounded border border-[#451a03]"><span class="text-[#9a3412]">Twitter:</span> <a href="${item.twitter}" target="_blank" class="text-[#fb923c] hover:underline truncate block">${item.twitter || '-'}</a></div>
                            <div class="bg-[#0f0502] p-2 rounded border border-[#451a03]"><span class="text-[#9a3412]">Web:</span> <a href="${item.website}" target="_blank" class="text-[#fb923c] hover:underline truncate block">${item.website || '-'}</a></div>
                        </div>
                        <div class="bg-[#0f0502] p-3 rounded border border-[#451a03] text-xs text-[#d1d5db]"><span class="text-[#9a3412] block mb-1">Description:</span>${item.description || 'No description provided.'}</div>
                        ${item.banner ? `<div class="text-xs text-[#9a3412] mt-2">Banner: <a href="${item.banner}" target="_blank" class="text-blue-400 underline">View Image</a></div>` : ''}
                    </div>
                    <div class="flex flex-col gap-2 justify-center min-w-[120px]">
                        ${currentTab === 'pending' ? `
                            <button onclick="approve(${item.id})" class="btn btn-green w-full">Approve</button>
                            <button onclick="reject(${item.id})" class="btn btn-red w-full">Reject</button>
                        ` : `<div class="text-center text-xs text-[#9a3412]">Action Taken</div>`}
                    </div>
                </div>
            `).join('');
            lucide.createIcons();
        }

        async function approve(id) {
            if (!confirm("Approve this update?")) return;
            try {
                const res = await fetch(`${API_URL}/api/admin/approve-update`, { method: 'POST', headers: { 'Content-Type': 'application/json', 'x-admin-auth': AUTH_KEY }, body: JSON.stringify({ id }) });
                const data = await res.json();
                if (data.success) fetchUpdates(); else alert(data.error);
            } catch (e) { alert("Network Error"); }
        }

        async function reject(id) {
            if (!confirm("Reject this update?")) return;
            try {
                const res = await fetch(`${API_URL}/api/admin/reject-update`, { method: 'POST', headers: { 'Content-Type': 'application/json', 'x-admin-auth': AUTH_KEY }, body: JSON.stringify({ id }) });
                const data = await res.json();
                if (data.success) fetchUpdates(); else alert(data.error);
            } catch (e) { alert("Network Error"); }
        }

        // --- MANAGE TOKEN LOGIC ---
        async function loadToken() {
            const mint = document.getElementById('manage-mint').value;
            const btn = event.currentTarget;
            const ogText = btn.innerHTML;
            btn.innerText = 'Loading...'; btn.disabled = true;

            try {
                const res = await fetch(`${API_URL}/api/admin/token/${mint}`, { headers: { 'x-admin-auth': AUTH_KEY } });
                const data = await res.json();
                if (data.success) {
                    document.getElementById('manage-form').classList.remove('hidden');
                    document.getElementById('edit-ticker').value = data.token.ticker || 'N/A';
                    document.getElementById('edit-holders').value = (data.token.holders || 0).toLocaleString();
                    document.getElementById('edit-twitter').value = data.token.twitter || '';
                    document.getElementById('edit-website').value = data.token.website || '';
                    document.getElementById('edit-telegram').value = data.token.telegram || '';
                    document.getElementById('edit-banner').value = data.token.banner || '';
                    document.getElementById('edit-description').value = data.token.description || '';
                } else { alert("Token not found"); document.getElementById('manage-form').classList.add('hidden'); }
            } catch (e) { alert("Error loading token"); }
            finally { btn.innerHTML = ogText; btn.disabled = false; }
        }

        async function saveToken() {
            const mint = document.getElementById('manage-mint').value;
            const twitter = document.getElementById('edit-twitter').value;
            const website = document.getElementById('edit-website').value;
            const telegram = document.getElementById('edit-telegram').value;
            const banner = document.getElementById('edit-banner').value;
            const description = document.getElementById('edit-description').value;
            
            try { 
                await fetch(`${API_URL}/api/admin/update-token`, { 
                    method: 'POST', headers: { 'Content-Type': 'application/json', 'x-admin-auth': AUTH_KEY }, 
                    body: JSON.stringify({ mint, twitter, website, telegram, banner, description }) 
                }); 
                alert("Token Updated!"); 
            } catch(e) { alert("Network Error"); }
        }

        async function deleteToken() {
            if(!confirm("DANGER: This will delete the token and ALL associated data. This cannot be undone.")) return;
            const mint = document.getElementById('manage-mint').value;
            try { 
                const res = await fetch(`${API_URL}/api/admin/delete-token`, { 
                    method: 'POST', headers: { 'Content-Type': 'application/json', 'x-admin-auth': AUTH_KEY }, 
                    body: JSON.stringify({ mint }) 
                }); 
                const data = await res.json();
                if(data.success) { alert("Token deleted."); document.getElementById('manage-form').classList.add('hidden'); document.getElementById('manage-mint').value = ''; } 
                else { alert("Delete Failed: " + data.error); }
            } catch(e) { alert("Network Error"); }
        }

        async function refreshKScore() {
            const mint = document.getElementById('manage-mint').value;
            try {
                const res = await fetch(`${API_URL}/api/admin/refresh-kscore`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json', 'x-admin-auth': AUTH_KEY },
                    body: JSON.stringify({ mint })
                });
                const data = await res.json();
                if (data.success) alert(data.message); else alert("Error: " + data.error);
            } catch (e) { alert("Network Error"); }
        }

        // --- BACKUP & RESTORE ---
        async function downloadBackup() {
            try {
                const res = await fetch(`${API_URL}/api/admin/backup/updates`, { headers: { 'x-admin-auth': AUTH_KEY } });
                if (!res.ok) throw new Error("Backup Failed");
                const blob = await res.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a'); a.href = url; a.download = `holdex_updates_${Date.now()}.json`;
                document.body.appendChild(a); a.click(); document.body.removeChild(a); window.URL.revokeObjectURL(url);
            } catch (e) { alert("Backup Error: " + e.message); }
        }

        function handleRestore(input) {
            const file = input.files[0]; if (!file) return;
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const json = JSON.parse(e.target.result);
                    const updates = Array.isArray(json) ? json : (json.data || []);
                    if (updates.length === 0) return alert("No updates found.");
                    if (!confirm(`Restore ${updates.length} updates? (Duplicates skipped)`)) { input.value = ''; return; }
                    const res = await fetch(`${API_URL}/api/admin/restore/updates`, {
                        method: 'POST', headers: { 'Content-Type': 'application/json', 'x-admin-auth': AUTH_KEY },
                        body: JSON.stringify({ updates })
                    });
                    const data = await res.json();
                    if (data.success) { alert(data.message); fetchUpdates(); } else { alert("Restore Failed: " + data.error); }
                } catch (err) { alert("Invalid JSON"); } finally { input.value = ''; }
            };
            reader.readAsText(file);
        }

        init();
    </script>
</body>
</html>
