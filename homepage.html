<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HolDex | The Terminal Fire Explorer</title>
    
    <!-- ========================================== -->
    <!-- 1. ESSENTIAL LIBRARIES                     -->
    <!-- ========================================== -->
    <script src="https://bundle.run/buffer@6.0.3"></script>
    <script>
        if (typeof window.buffer !== 'undefined') {
            window.Buffer = window.buffer.Buffer;
        }
    </script>
    <script src="https://unpkg.com/@solana/web3.js@1.91.0/lib/index.iife.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Comic+Neue:wght@400;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        fire: { bg: '#2a1005', panel: '#451a03', border: '#7c2d12', accent: '#ea580c', text: '#ffedd5', highlight: '#fb923c' },
                        void: '#0f0502'
                    },
                    fontFamily: { mono: ['JetBrains Mono', 'monospace'], sans: ['Comic Neue', 'cursive'] }
                }
            }
        }
    </script>
    <style>
        body { background-color: #2a1005; color: #ffedd5; font-family: 'Comic Neue', cursive; min-height: 100vh; font-size: 14px; overflow-x: hidden; padding-bottom: 60px; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #2a1005; }
        ::-webkit-scrollbar-thumb { background: #7c2d12; border-radius: 4px; border: 1px solid #451a03; }
        ::-webkit-scrollbar-thumb:hover { background: #ea580c; }
        nav { background: rgba(42, 16, 5, 0.95); backdrop-filter: blur(12px); border-bottom: 2px solid #7c2d12; }
        .brand-text { color: #ea580c; text-shadow: 2px 2px 0px #451a03; font-weight: 800; letter-spacing: 1px; }
        .holdex-table { width: 100%; border-collapse: separate; border-spacing: 0; }
        .holdex-table th { background: #451a03; position: sticky; top: 0; z-index: 20; padding: 14px 12px; text-align: right; font-size: 12px; font-weight: 700; color: #fb923c; border-bottom: 2px solid #7c2d12; cursor: pointer; white-space: nowrap; text-transform: uppercase; transition: color 0.2s, background 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        .holdex-table th:hover { background: #582206; color: #fff; }
        .holdex-table th:first-child { text-align: left; padding-left: 20px; }
        .holdex-table td { padding: 12px 12px; border-bottom: 1px solid rgba(124, 45, 18, 0.3); vertical-align: middle; font-family: 'JetBrains Mono', monospace; }
        .holdex-table td:first-child { padding-left: 20px; }
        .holdex-table tr:hover td { background: rgba(234, 88, 12, 0.1); }
        .img-token { width: 40px; height: 40px; border-radius: 8px; border: 2px solid #7c2d12; object-fit: cover; flex-shrink: 0; background: #000; }
        .pill { padding: 4px 8px; border-radius: 6px; font-size: 11px; font-weight: 700; font-family: 'JetBrains Mono'; }
        .pill-green { background: rgba(34, 197, 94, 0.15); color: #4ade80; border: 1px solid rgba(34, 197, 94, 0.4); }
        .pill-red { background: rgba(239, 68, 68, 0.15); color: #fca5a5; border: 1px solid rgba(239, 68, 68, 0.4); }
        .search-box { background: #451a03; border: 2px solid #7c2d12; color: #fb923c; padding: 10px 16px; border-radius: 8px; outline: none; width: 100%; font-family: 'JetBrains Mono'; transition: border-color 0.2s; }
        .search-box:focus { border-color: #ea580c; }
        .nav-btn { background: transparent; color: #9a3412; padding: 8px 20px; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 800; transition: all 0.2s; border: 2px solid transparent; }
        .nav-btn.active { background: #451a03; color: #ea580c; border-color: #7c2d12; box-shadow: 0 4px 0 #2a1005; }
        .filter-toggle { background: #451a03; border: 2px solid #7c2d12; color: #9a3412; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-size: 12px; font-weight: 700; transition: all 0.2s; display: flex; align-items: center; gap: 6px; }
        .filter-toggle.active { border-color: #22c55e; color: #4ade80; background: rgba(34, 197, 94, 0.1); }
        .refresh-btn { background: #451a03; border: 2px solid #7c2d12; color: #fb923c; width: 42px; height: 42px; display: flex; align-items: center; justify-content: center; border-radius: 8px; cursor: pointer; transition: all 0.2s; }
        .refresh-btn:hover { border-color: #ea580c; color: #fff; background: #582206; }
        .page-btn { background: #2a1005; border: 2px solid #7c2d12; color: #fb923c; padding: 8px 16px; border-radius: 8px; font-weight: bold; font-family: 'JetBrains Mono', monospace; cursor: pointer; }
        .page-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .view-section { display: none; }
        .view-section.active { display: block; animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .chart-container { width: 100%; height: 500px; background: #1a0a05; border-radius: 16px; overflow: hidden; border: 2px solid #7c2d12; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .stat-card { background: rgba(69, 26, 3, 0.8); border: 2px solid #7c2d12; border-radius: 12px; padding: 16px; display: flex; flex-direction: column; gap: 4px; box-shadow: 4px 4px 0 rgba(0,0,0,0.2); }
        .stat-label { font-size: 11px; color: #fb923c; text-transform: uppercase; letter-spacing: 0.05em; font-weight: 700; }
        .stat-value { font-size: 18px; font-weight: 700; color: #fff; font-family: 'JetBrains Mono'; }
        .modal-overlay { position: fixed; inset: 0; background: rgba(15, 5, 2, 0.95); backdrop-filter: blur(5px); z-index: 100; display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: opacity 0.3s; }
        .modal-overlay.open { opacity: 1; pointer-events: auto; }
        .status-bar { position: fixed; bottom: 0; left: 0; width: 100%; background: #451a03; border-top: 2px solid #ea580c; padding: 0 24px; height: 50px; display: flex; justify-content: space-between; align-items: center; z-index: 50; box-shadow: 0 -5px 20px rgba(234, 88, 12, 0.2); }
        .action-btn { background: #451a03; border: 2px solid #ea580c; color: #fb923c; padding: 12px 20px; border-radius: 12px; font-weight: 700; text-transform: uppercase; font-size: 13px; transition: all 0.2s; box-shadow: 4px 4px 0 #7c2d12; cursor: pointer; }
        .action-btn:hover { transform: translate(-2px, -2px); box-shadow: 6px 6px 0 #7c2d12; background: #582206; color: #fff; }
        .form-input { background: #451a03; border: 2px solid #7c2d12; color: #fb923c; padding: 12px; border-radius: 8px; width: 100%; font-family: 'JetBrains Mono'; margin-bottom: 16px; outline: none; transition: border-color 0.2s; }
        .form-label { display: block; color: #9a3412; font-size: 12px; font-weight: bold; margin-bottom: 6px; text-transform: uppercase; }
        .status-bar-btn { padding: 6px 12px; border-radius: 6px; border: 1px solid #7c2d12; background: #2a1005; color: #9a3412; font-size: 11px; font-weight: bold; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 6px; white-space: nowrap; }
        .status-bar-btn.connected { border-color: #22c55e; color: #22c55e; background: rgba(34, 197, 94, 0.1); }
        .pulse-dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-left: 8px; border: 1px solid rgba(255,255,255,0.2); }
        .pulse-dot.green { background: #22c55e; box-shadow: 0 0 12px #22c55e; animation: pulseGlow 2s infinite; }
        @keyframes pulseGlow { 0% { opacity: 1; box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.4); } 70% { opacity: 1; box-shadow: 0 0 0 10px rgba(34, 197, 94, 0); } 100% { opacity: 1; box-shadow: 0 0 0 0 rgba(34, 197, 94, 0); } }
        .tx-link { color: #3b82f6; text-decoration: underline; font-family: 'JetBrains Mono'; font-size: 11px; display: block; margin-top: 8px; }
        .verified-badge { display: inline-flex; align-items: center; justify-content: center; background: rgba(34, 197, 94, 0.15); border: 1px solid #22c55e; color: #22c55e; border-radius: 50%; width: 20px; height: 20px; margin-left: 6px; box-shadow: 0 0 10px rgba(34, 197, 94, 0.3); }
        .pool-tab { padding: 8px 16px; font-size: 12px; font-weight: bold; color: #9a3412; cursor: pointer; border-bottom: 2px solid transparent; }
        .pool-tab.active { color: #ea580c; border-bottom-color: #ea580c; }
        .social-btn { display: flex; align-items: center; justify-content: center; width: 42px; height: 42px; border-radius: 12px; border: 2px solid #7c2d12; background: #451a03; color: #ea580c; transition: all 0.2s; }
        .social-btn:hover { border-color: #ea580c; color: #fff; background: #582206; transform: translateY(-2px); }
    </style>
</head>
<body>

<nav class="sticky top-0 z-40">
    <div class="max-w-[1800px] mx-auto px-4 md:px-6 py-4 flex flex-col md:flex-row md:justify-between md:items-center gap-4">
        <div class="flex items-center justify-between w-full md:w-auto">
            <div class="flex items-center gap-4 cursor-pointer group" onclick="navigateTo('')">
                <div class="w-12 h-12 rounded-xl flex items-center justify-center bg-[#451a03] text-orange-500 border-2 border-[#7c2d12] shadow-lg group-hover:border-orange-500 transition">
                    <i data-lucide="flame" width="24"></i>
                </div>
                <h1 class="text-3xl brand-text tracking-tight font-sans">HolDex</h1>
            </div>
        </div>
        <div class="flex items-center bg-[#451a03]/50 p-1 rounded-lg border border-[#7c2d12]/50">
            <button class="nav-btn active" onclick="navigateTo('')">Home</button>
            <button class="nav-btn" onclick="navigateTo('about')">About</button>
            <button class="nav-btn" onclick="navigateTo('update')">Update</button>
        </div>
        <div id="table-controls" class="flex items-center gap-3 w-full md:w-auto">
            <button id="filter-verified" onclick="toggleVerifiedFilter()" class="filter-toggle" title="Show only Verified Community Updates">
                <i data-lucide="shield-check" width="16"></i> Verified Only
            </button>
            <div class="relative w-full md:w-auto">
                <input type="text" id="search" placeholder="Search..." class="search-box" onkeyup="handleSearch(event)">
            </div>
            <button onclick="handleManualRefresh()" class="refresh-btn"><i data-lucide="refresh-cw" width="18"></i></button>
        </div>
        <div id="detail-controls" class="hidden w-full md:w-auto">
            <button onclick="navigateTo('')" class="back-btn flex items-center gap-2 px-6 py-2 border-2 border-[#7c2d12] rounded-xl"><i data-lucide="arrow-left" width="16"></i> Back</button>
        </div>
    </div>
</nav>

<main class="max-w-[1800px] mx-auto px-4 md:px-6 py-4 md:py-8">
    
    <!-- DASHBOARD VIEW -->
    <div id="view-dashboard" class="view-section active">
        <div class="bg-[#2a1005] border-2 border-[#7c2d12] md:rounded-2xl overflow-hidden shadow-2xl flex flex-col">
            <div class="overflow-x-auto">
                <table class="holdex-table">
                    <thead>
                        <tr>
                            <th width="40%" onclick="setSort('newest')">Asset <i data-lucide="arrow-down-up" width="10" class="inline"></i></th>
                            <th onclick="setSort('kscore')">K-Score</th>
                            <th onclick="setSort('mcap')">Mkt Cap</th>
                            <th onclick="setSort('volume')">Vol (24h)</th>
                            <th onclick="setSort('24h')">24h Change</th>
                        </tr>
                    </thead>
                    <tbody id="table-body">
                        <tr><td colspan="5" class="text-center py-20 text-[#ea580c] animate-pulse">Scanning the Solana Grid...</td></tr>
                    </tbody>
                </table>
            </div>
            <div class="bg-[#451a03] p-4 border-t-2 border-[#7c2d12] flex justify-between items-center">
                <div id="page-info" class="text-xs text-[#9a3412] font-mono font-bold uppercase">Page 1</div>
                <div class="flex gap-4">
                    <button id="btn-prev" onclick="changePage(-1)" class="page-btn" disabled>Previous</button>
                    <button id="btn-next" onclick="changePage(1)" class="page-btn">Next</button>
                </div>
            </div>
        </div>
    </div>

    <!-- UPDATE VIEW -->
    <div id="view-update" class="view-section px-4">
        <div class="bg-[#2a1005] border-2 border-[#7c2d12] rounded-2xl p-8 shadow-2xl max-w-2xl mx-auto">
            <h2 class="text-2xl font-bold mb-6 flex items-center gap-3"><i data-lucide="edit-3" class="text-[#ea580c]"></i> Update Token</h2>
            
            <form onsubmit="submitUpdate(event)" class="space-y-4">
                <div>
                    <label class="form-label">Token Mint Address</label>
                    <input type="text" id="update-mint" class="form-input" placeholder="Enter Solana Mint Address..." required onblur="fetchTokenForUpdate(this.value)">
                </div>

                <div id="token-preview-info" class="hidden p-4 bg-[#451a03] border border-[#7c2d12] rounded-lg flex items-center gap-4 mb-4">
                    <img id="update-token-img" class="w-12 h-12 rounded bg-black">
                    <div>
                        <div class="font-bold" id="update-token-name"></div>
                        <div class="text-xs text-[#9a3412] font-mono" id="update-token-ticker"></div>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <input type="url" id="update-twitter" class="form-input" placeholder="Twitter URL">
                    <input type="url" id="update-telegram" class="form-input" placeholder="Telegram URL">
                </div>
                <input type="url" id="update-website" class="form-input" placeholder="Website URL">

                <div>
                    <label class="form-label">Project Description (Max 250 characters)</label>
                    <textarea id="update-description" class="form-input h-28 resize-none" maxlength="250" placeholder="Brief project overview..."></textarea>
                    <div class="text-right text-[10px] text-[#9a3412] font-bold mt-[-10px] mb-4"><span id="char-count">0</span>/250</div>
                </div>

                <input type="url" id="update-banner" class="form-input" placeholder="Banner Image URL (Imgur recommended)">

                <button type="submit" id="submit-btn" class="action-btn w-full flex items-center justify-center gap-2" disabled>
                    <i data-lucide="wallet" width="18"></i> Pay Fee & Submit Update
                </button>
            </form>
            <div id="update-status" class="mt-6 p-4 rounded-lg bg-[#451a03] border border-[#7c2d12] text-center hidden"></div>
        </div>
    </div>

    <!-- DETAIL VIEW -->
    <div id="view-detail" class="view-section px-4">
        <div id="detail-loading" class="text-center py-20 text-[#ea580c] animate-pulse">Indexing Project Data...</div>
        <div id="detail-content" class="hidden">
            <div id="detail-banner-container" class="mb-8"></div>
            
            <div class="flex flex-col md:flex-row gap-8 items-start mb-8">
                <div class="bg-[#451a03] p-6 rounded-2xl border-2 border-[#7c2d12] shadow-xl flex items-center gap-6 w-full md:w-auto">
                    <img id="detail-img" class="w-24 h-24 rounded-xl object-cover border-2 border-[#ea580c]">
                    <div>
                        <div class="flex items-center gap-3">
                            <h2 id="detail-ticker" class="text-4xl font-bold font-mono"></h2>
                            <span id="detail-verified" class="verified-badge hidden"><i data-lucide="check" width="12"></i></span>
                        </div>
                        <p id="detail-name" class="text-[#fb923c] text-lg"></p>
                        <div id="detail-mint" class="text-[10px] text-[#9a3412] mt-1 font-mono break-all cursor-pointer hover:text-white" onclick="navigator.clipboard.writeText(this.innerText)"></div>
                    </div>
                </div>
                <div class="flex-1">
                    <div id="detail-desc-box" class="hidden bg-[#451a03]/40 border border-[#7c2d12] p-6 rounded-xl">
                        <h4 class="text-xs font-bold text-[#9a3412] uppercase tracking-widest mb-3">Project Vision</h4>
                        <p id="detail-desc-text" class="text-[#ffedd5] leading-relaxed text-sm"></p>
                    </div>
                </div>
                <div id="detail-actions" class="flex gap-3"></div>
            </div>

            <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4 mb-8">
                <div class="stat-card border-[#ea580c]"><span class="stat-label text-[#ea580c]">K-Score</span><span id="stat-kscore" class="stat-value">-</span></div>
                <div class="stat-card"><span class="stat-label">Market Cap</span><span id="stat-mcap" class="stat-value">-</span></div>
                <div class="stat-card"><span class="stat-label">Volume (24h)</span><span id="stat-vol" class="stat-value">-</span></div>
                <div class="stat-card"><span class="stat-label">1h Change</span><span id="stat-1h" class="stat-value">-</span></div>
                <div class="stat-card"><span class="stat-label">24h Change</span><span id="stat-24h" class="stat-value">-</span></div>
            </div>
            
            <div id="pool-tabs" class="flex gap-4 border-b border-[#7c2d12] mb-4 overflow-x-auto"></div>
            <div class="chart-container"><iframe id="detail-iframe" class="w-full h-full border-0 bg-black"></iframe></div>
        </div>
    </div>
</main>

<div class="status-bar">
    <div class="flex items-center gap-3">
        <span class="text-xs font-bold text-[#ea580c] font-mono">LIVE FEED ACTIVE</span>
        <span class="pulse-dot green"></span>
    </div>
    <button id="statusbar-wallet-btn" onclick="openWalletModal()" class="status-bar-btn">
        <i data-lucide="wallet" width="14"></i> <span>Connect Wallet</span>
    </button>
</div>

<!-- WALLET MODAL -->
<div id="wallet-modal" class="modal-overlay">
    <div class="bg-[#2a1005] border-2 border-[#ea580c] p-8 rounded-2xl max-w-sm w-full relative">
        <button onclick="closeWalletModal()" class="absolute top-4 right-4 text-[#9a3412]"><i data-lucide="x"></i></button>
        <h3 class="text-xl font-bold mb-6 text-center">Establish Connection</h3>
        <div class="space-y-3">
            <button onclick="connectProvider('phantom')" class="w-full p-4 border-2 border-[#7c2d12] rounded-xl flex justify-between items-center hover:border-[#ea580c]"><span>Phantom</span><i data-lucide="ghost"></i></button>
            <button onclick="connectProvider('solflare')" class="w-full p-4 border-2 border-[#7c2d12] rounded-xl flex justify-between items-center hover:border-[#ea580c]"><span>Solflare</span><i data-lucide="flame"></i></button>
        </div>
    </div>
</div>

<script>
    // --- Configuration ---
    const API_URL = 'https://asdev-backend.onrender.com';
    const HELIUS_API_KEY = "9cf39f1e-049f-49c7-8884-781b37344379"; 
    const RPC_ENDPOINTS = HELIUS_API_KEY ? [`https://mainnet.helius-rpc.com/?api-key=${HELIUS_API_KEY}`] : ["https://api.mainnet-beta.solana.com", "https://rpc.ankr.com/solana"];
    const FALLBACK_BANNER = "https://images.squarespace-cdn.com/content/690b8c21384b3f1201c2650c/967ea61f-a88a-4497-81c2-5c67d3d06d9e/Gemini_Generated_Image_c82gwyc82gwyc82g.png";

    // --- State ---
    let walletAddress = null;
    let walletProvider = null;
    let currentSort = 'newest';
    let searchQuery = '';
    let isVerifiedFilter = false;
    let currentPage = 1;
    let feeConfig = { solFee: 0.1, tokenFee: 1000, treasury: '', tokenMint: '' };
    let currentUpdateTokenData = null;

    // --- Init ---
    window.onload = () => {
        handleRoute();
        fetchFees();
        const descInput = document.getElementById('update-description');
        if(descInput) {
            descInput.addEventListener('input', e => {
                document.getElementById('char-count').innerText = e.target.value.length;
            });
        }
    };
    window.addEventListener('hashchange', handleRoute);

    async function fetchFees() {
        try {
            const res = await fetch(`${API_URL}/api/config/fees`);
            const data = await res.json();
            if(data.success) feeConfig = data;
        } catch(e) {}
    }

    // --- Navigation ---
    function navigateTo(h) { window.location.hash = h; }
    function handleRoute() {
        const h = window.location.hash;
        document.querySelectorAll('.view-section').forEach(v => v.classList.remove('active'));
        document.getElementById('table-controls').classList.add('hidden');
        document.getElementById('detail-controls').classList.add('hidden');

        if (!h || h === '#') {
            document.getElementById('view-dashboard').classList.add('active');
            document.getElementById('table-controls').classList.remove('hidden');
            fetchList();
        } else if (h === '#update') {
            document.getElementById('view-update').classList.add('active');
        } else if (h.startsWith('#token/')) {
            document.getElementById('view-detail').classList.add('active');
            document.getElementById('detail-controls').classList.remove('hidden');
            showDetail(h.split('/')[1]);
        }
    }

    // --- Wallet ---
    function openWalletModal() { document.getElementById('wallet-modal').classList.add('open'); }
    function closeWalletModal() { document.getElementById('wallet-modal').classList.remove('open'); }

    async function connectProvider(p) {
        const provider = p === 'phantom' ? window.solana : window.solflare;
        if (!provider) return alert("Wallet not found");
        try {
            const resp = await provider.connect();
            walletAddress = resp.publicKey.toString();
            walletProvider = provider;
            closeWalletModal();
            updateWalletUI(true);
        } catch (e) {}
    }

    function updateWalletUI(connected) {
        const barBtn = document.getElementById('statusbar-wallet-btn');
        const submitBtn = document.getElementById('submit-btn');
        if (connected) {
            barBtn.innerHTML = `<span>${walletAddress.slice(0,4)}...${walletAddress.slice(-4)}</span>`;
            barBtn.classList.add('connected');
            if(submitBtn) submitBtn.disabled = false;
        }
    }

    // --- Dashboard ---
    async function fetchList() {
        try {
            const url = `${API_URL}/api/tokens?sort=${currentSort}&search=${encodeURIComponent(searchQuery)}&page=${currentPage}${isVerifiedFilter ? '&filter=verified' : ''}`;
            const res = await fetch(url);
            const data = await res.json();
            if(data.success) renderTable(data.tokens);
            document.getElementById('page-info').innerText = `Page ${currentPage}`;
            document.getElementById('btn-prev').disabled = currentPage <= 1;
        } catch(e) {}
    }

    function renderTable(tokens) {
        const tbody = document.getElementById('table-body');
        if(!tokens.length) { tbody.innerHTML = `<tr><td colspan="5" class="text-center py-20 text-[#9a3412]">No results found.</td></tr>`; return; }
        
        tbody.innerHTML = tokens.map(t => `
            <tr onclick="navigateTo('token/${t.mint}')" class="cursor-pointer hover:bg-white/5">
                <td class="p-4 flex items-center gap-3">
                    <img src="${t.image}" class="img-token" onerror="this.src='https://placehold.co/40'">
                    <div>
                        <div class="font-bold flex items-center gap-2">${t.ticker}${t.hasCommunityUpdate ? '<i data-lucide="check-circle" class="w-3 h-3 text-green-500"></i>' : ''}</div>
                        <div class="text-[10px] text-[#9a3412] font-mono">${t.name}</div>
                    </div>
                </td>
                <td class="text-right font-mono font-bold text-[#fb923c]">${t.hasCommunityUpdate ? (t.kScore || 0) : 'üîí'}</td>
                <td class="text-right font-mono">$${(t.marketCap || 0).toLocaleString()}</td>
                <td class="text-right font-mono">$${(t.volume24h || 0).toLocaleString()}</td>
                <td class="text-right font-mono ${t.change24h > 0 ? 'text-green-500' : 'text-red-500'}">${t.change24h?.toFixed(2)}%</td>
            </tr>
        `).join('');
        lucide.createIcons();
    }

    window.setSort = (s) => { currentSort = s; currentPage = 1; fetchList(); };
    window.handleSearch = (e) => { searchQuery = e.target.value; currentPage = 1; clearTimeout(window.searchT); window.searchT = setTimeout(fetchList, 800); };
    window.toggleVerifiedFilter = () => { isVerifiedFilter = !isVerifiedFilter; document.getElementById('filter-verified').classList.toggle('active'); currentPage = 1; fetchList(); };
    window.changePage = (d) => { currentPage += d; fetchList(); };
    window.handleManualRefresh = () => fetchList();

    // --- Detail ---
    async function showDetail(mint) {
        const loading = document.getElementById('detail-loading');
        const content = document.getElementById('detail-content');
        loading.classList.remove('hidden'); content.classList.add('hidden');

        try {
            const res = await fetch(`${API_URL}/api/token/${mint}`);
            const data = await res.json();
            if(data.success) {
                const t = data.token;
                document.getElementById('detail-ticker').innerText = t.ticker;
                document.getElementById('detail-name').innerText = t.name;
                document.getElementById('detail-mint').innerText = t.mint;
                document.getElementById('detail-img').src = t.image;
                
                const verified = document.getElementById('detail-verified');
                if(t.hasCommunityUpdate) verified.classList.remove('hidden'); else verified.classList.add('hidden');

                // Description
                const descBox = document.getElementById('detail-desc-box');
                const descText = document.getElementById('detail-desc-text');
                if (t.description) {
                    descText.innerText = t.description;
                    descBox.classList.remove('hidden');
                } else { descBox.classList.add('hidden'); }

                // Banner
                const bannerContainer = document.getElementById('detail-banner-container');
                if (t.banner) {
                    bannerContainer.innerHTML = `<div class="w-full h-48 md:h-64 rounded-xl border-2 border-[#7c2d12] relative overflow-hidden bg-black shadow-lg"><img src="${t.banner}" class="w-full h-full object-cover" onerror="this.src='${FALLBACK_BANNER}'"></div>`;
                } else { bannerContainer.innerHTML = ''; }

                // Stats
                document.getElementById('stat-kscore').innerText = t.hasCommunityUpdate ? (t.kScore || 0) : 'üîí';
                document.getElementById('stat-mcap').innerText = '$' + (t.marketCap || 0).toLocaleString();
                document.getElementById('stat-vol').innerText = '$' + (t.volume24h || 0).toLocaleString();
                document.getElementById('stat-1h').innerText = (t.change1h || 0).toFixed(2) + '%';
                document.getElementById('stat-24h').innerText = (t.change24h || 0).toFixed(2) + '%';

                // Chart
                document.getElementById('detail-iframe').src = `https://dexscreener.com/solana/${mint}?embed=1&theme=dark&info=0`;
                
                loading.classList.add('hidden'); content.classList.remove('hidden');
                lucide.createIcons();
            }
        } catch(e) {}
    }

    // --- Update Process ---
    async function fetchTokenForUpdate(m) {
        if(m.length < 32) return;
        const res = await fetch(`${API_URL}/api/tokens?search=${m}`);
        const data = await res.json();
        if(data.success && data.tokens[0]) {
            currentUpdateTokenData = data.tokens[0];
            document.getElementById('update-token-img').src = currentUpdateTokenData.image;
            document.getElementById('update-token-name').innerText = currentUpdateTokenData.name;
            document.getElementById('update-token-ticker').innerText = currentUpdateTokenData.ticker;
            document.getElementById('token-preview-info').classList.remove('hidden');
        }
    }

    async function submitUpdate(e) {
        e.preventDefault();
        const status = document.getElementById('update-status');
        status.classList.remove('hidden', 'text-red-500', 'text-green-500');
        status.className = "mt-6 p-4 rounded-lg bg-[#451a03] border border-[#ea580c] text-[#ea580c] font-mono text-sm";
        status.innerHTML = "Initializing Connection...";

        try {
            let connection, blockhash;
            for(let url of RPC_ENDPOINTS) {
                try {
                    const conn = new solanaWeb3.Connection(url, 'confirmed');
                    const bh = await conn.getLatestBlockhash();
                    connection = conn; blockhash = bh.blockhash; break;
                } catch(err) {}
            }
            if(!connection) throw new Error("Network latency high. Try again.");

            const payer = new solanaWeb3.PublicKey(walletAddress);
            const treasury = new solanaWeb3.PublicKey(feeConfig.treasury);
            const mint = new solanaWeb3.PublicKey(feeConfig.tokenMint);

            const tx = new solanaWeb3.Transaction();
            tx.add(solanaWeb3.SystemProgram.transfer({ fromPubkey: payer, toPubkey: treasury, lamports: feeConfig.solFee * 1e9 }));

            const getATA = async (own, m) => {
                const [addr] = await solanaWeb3.PublicKey.findProgramAddress(
                    [own.toBuffer(), new solanaWeb3.PublicKey('TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA').toBuffer(), m.toBuffer()],
                    new solanaWeb3.PublicKey('ATokenGPvbdGVxr1b2hvZbsiqW5xWH25efTNsLJA8knL')
                );
                return addr;
            };

            const sATA = await getATA(payer, mint);
            const dATA = await getATA(treasury, mint);

            const data = new Uint8Array(9);
            data[0] = 3;
            let amt = BigInt(Math.floor(feeConfig.tokenFee * 1e6));
            for (let i = 0; i < 8; i++) { data[i+1] = Number(amt & 0xFFn); amt >>= 8n; }

            tx.add(new solanaWeb3.TransactionInstruction({
                keys: [{pubkey: sATA, isSigner: false, isWritable: true}, {pubkey: dATA, isSigner: false, isWritable: true}, {pubkey: payer, isSigner: true, isWritable: false}],
                programId: new solanaWeb3.PublicKey('TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA'),
                data: data
            }));

            tx.recentBlockhash = blockhash;
            tx.feePayer = payer;

            status.innerHTML = "Awaiting Signature...";
            const { signature } = await walletProvider.signAndSendTransaction(tx);

            status.innerHTML = `Transaction Broadcasted!<br>Verifying on-chain...<br><a href="https://solscan.io/tx/${signature}" target="_blank" class="tx-link">Solscan: ${signature.slice(0,10)}...</a>`;

            const res = await fetch(`${API_URL}/api/request-update`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    mint: document.getElementById('update-mint').value,
                    twitter: document.getElementById('update-twitter').value,
                    website: document.getElementById('update-website').value,
                    telegram: document.getElementById('update-telegram').value,
                    banner: document.getElementById('update-banner').value,
                    description: document.getElementById('update-description').value,
                    signature, userPublicKey: walletAddress
                })
            });

            const result = await res.json();
            if(result.success) {
                status.className = "mt-6 p-4 rounded-lg bg-green-900/20 border border-green-500 text-green-500 font-mono text-sm";
                status.innerHTML = `‚úÖ Submission Received!<br><a href="https://solscan.io/tx/${signature}" target="_blank" class="tx-link">Solscan: ${signature.slice(0,16)}...</a>`;
            } else {
                throw new Error(result.error);
            }
        } catch (e) {
            status.className = "mt-6 p-4 rounded-lg bg-red-900/20 border border-red-500 text-red-500 font-mono text-sm";
            status.innerText = "‚ùå " + e.message;
        }
    }

    lucide.createIcons();
</script>
</body>
</html>
