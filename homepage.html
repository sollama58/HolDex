<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HolDex | The Terminal Fire Explorer</title>
    
    <!-- 1. ESSENTIAL LIBRARIES -->
    <script src="https://bundle.run/buffer@6.0.3"></script>
    <script>if (typeof window.buffer !== 'undefined') window.Buffer = window.buffer.Buffer;</script>
    <script src="https://unpkg.com/@solana/web3.js@1.91.0/lib/index.iife.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- NEW: Lightweight Charts for Custom Charting -->
    <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Comic+Neue:wght@400;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        fire: { bg: '#2a1005', panel: '#451a03', border: '#7c2d12', accent: '#ea580c', text: '#ffedd5' },
                        void: '#0f0502'
                    },
                    fontFamily: { mono: ['JetBrains Mono', 'monospace'], sans: ['Comic Neue', 'cursive'] }
                }
            }
        }
    </script>
    <style>
        body { background-color: #2a1005; color: #ffedd5; font-family: 'Comic Neue', cursive; min-height: 100vh; padding-bottom: 60px; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #2a1005; }
        ::-webkit-scrollbar-thumb { background: #7c2d12; border-radius: 4px; }
        nav { background: rgba(42, 16, 5, 0.95); backdrop-filter: blur(12px); border-bottom: 2px solid #7c2d12; }
        .holdex-table { width: 100%; border-collapse: separate; border-spacing: 0; }
        .holdex-table th { background: #451a03; padding: 14px 12px; text-align: right; color: #fb923c; border-bottom: 2px solid #7c2d12; cursor: pointer; }
        .holdex-table th:first-child { text-align: left; padding-left: 20px; }
        .holdex-table td { padding: 12px; border-bottom: 1px solid rgba(124, 45, 18, 0.3); font-family: 'JetBrains Mono'; }
        .holdex-table tr:hover td { background: rgba(234, 88, 12, 0.1); }
        .img-token { width: 40px; height: 40px; border-radius: 8px; border: 2px solid #7c2d12; object-fit: cover; }
        
        /* Chart Container Styling */
        .chart-wrapper { width: 100%; height: 500px; background: #161b22; border: 2px solid #7c2d12; border-radius: 16px; overflow: hidden; position: relative; }
        #tv-chart { width: 100%; height: 100%; }
        
        .pill { padding: 4px 8px; border-radius: 6px; font-size: 11px; font-weight: 700; font-family: 'JetBrains Mono'; }
        .pill-green { background: rgba(34, 197, 94, 0.15); color: #4ade80; }
        .pill-red { background: rgba(239, 68, 68, 0.15); color: #fca5a5; }
        
        .view-section { display: none; }
        .view-section.active { display: block; animation: slideUp 0.4s; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<nav class="sticky top-0 z-40">
    <div class="max-w-[1800px] mx-auto px-4 py-4 flex justify-between items-center gap-4">
        <div class="flex items-center gap-4 cursor-pointer" onclick="navigateTo('')">
            <div class="w-12 h-12 rounded-xl flex items-center justify-center bg-[#451a03] border-2 border-[#7c2d12]">
                <i data-lucide="flame" width="24" class="text-orange-500"></i>
            </div>
            <h1 class="text-3xl font-bold text-orange-500 tracking-tight font-sans">HolDex</h1>
        </div>
        
        <div id="table-controls" class="flex gap-3">
            <input type="text" id="search" placeholder="Search..." class="bg-[#451a03] border-2 border-[#7c2d12] text-orange-400 px-4 py-2 rounded-lg outline-none w-64 font-mono" onkeyup="handleSearch(event)">
            <button onclick="fetchList()" class="bg-[#451a03] border-2 border-[#7c2d12] text-orange-400 p-2 rounded-lg hover:border-orange-500"><i data-lucide="refresh-cw" width="20"></i></button>
        </div>
        
        <div id="detail-controls" class="hidden">
            <button onclick="navigateTo('')" class="bg-[#2a1005] border-2 border-[#7c2d12] text-orange-800 hover:text-orange-500 px-4 py-2 rounded-lg font-bold flex gap-2"><i data-lucide="arrow-left" width="20"></i> Back</button>
        </div>
    </div>
</nav>

<main class="max-w-[1800px] mx-auto px-6 py-8">
    
    <!-- DASHBOARD VIEW -->
    <div id="view-dashboard" class="view-section active">
        <div class="bg-[#2a1005] border-2 border-[#7c2d12] rounded-2xl overflow-hidden shadow-2xl">
            <div class="overflow-x-auto">
                <table class="holdex-table">
                    <thead>
                        <tr>
                            <th width="40%">Asset</th>
                            <th>K-Score</th>
                            <th>Price</th>
                            <th>24h %</th>
                            <th>Mkt Cap</th>
                            <th>Vol 24h</th>
                        </tr>
                    </thead>
                    <tbody id="table-body">
                        <tr><td colspan="6" class="text-center py-20 text-orange-700 font-mono animate-pulse">Connecting to Indexer...</td></tr>
                    </tbody>
                </table>
            </div>
            <div class="bg-[#451a03] p-4 flex justify-between items-center border-t-2 border-[#7c2d12]">
                <span class="text-orange-900 font-bold text-xs uppercase">Live Feed</span>
                <div class="flex gap-2">
                    <button onclick="changePage(-1)" class="px-4 py-2 bg-[#2a1005] border border-[#7c2d12] rounded text-orange-400 font-mono text-xs">PREV</button>
                    <button onclick="changePage(1)" class="px-4 py-2 bg-[#2a1005] border border-[#7c2d12] rounded text-orange-400 font-mono text-xs">NEXT</button>
                </div>
            </div>
        </div>
    </div>

    <!-- DETAIL VIEW -->
    <div id="view-detail" class="view-section">
        <div id="detail-header" class="flex items-center gap-6 mb-8">
            <img id="detail-img" src="" class="w-20 h-20 rounded-xl border-2 border-orange-500 bg-black">
            <div>
                <h2 id="detail-ticker" class="text-4xl font-bold text-white font-mono"></h2>
                <span id="detail-name" class="text-orange-500 text-sm"></span>
            </div>
            <div class="ml-auto flex gap-3">
                <div class="bg-[#451a03] border border-[#7c2d12] rounded-lg p-3 text-center">
                    <div class="text-[10px] text-orange-900 uppercase font-bold">Price</div>
                    <div id="detail-price" class="text-xl font-mono text-white font-bold"></div>
                </div>
                <div class="bg-[#451a03] border border-[#7c2d12] rounded-lg p-3 text-center">
                    <div class="text-[10px] text-orange-900 uppercase font-bold">24h Vol</div>
                    <div id="detail-vol" class="text-xl font-mono text-green-500 font-bold"></div>
                </div>
            </div>
        </div>

        <!-- CUSTOM CHART CONTAINER -->
        <div class="chart-wrapper">
            <div id="tv-chart"></div>
            <div id="chart-loader" class="absolute inset-0 flex items-center justify-center bg-[#161b22] text-gray-500 font-mono z-10">Loading Candle Data...</div>
        </div>
    </div>

</main>

<script>
    const API_URL = 'https://asdev-backend.onrender.com'; // Change to local if running locally
    let chart, candleSeries;
    let currentMint = null;
    let currentPage = 1;

    window.onload = () => {
        initChart();
        navigateTo('');
    };

    function initChart() {
        const container = document.getElementById('tv-chart');
        chart = LightweightCharts.createChart(container, {
            layout: { background: { color: '#161b22' }, textColor: '#c9d1d9' },
            grid: { vertLines: { color: '#30363d', style: 2 }, horzLines: { color: '#30363d', style: 2 } },
            timeScale: { timeVisible: true, secondsVisible: false, borderColor: '#30363d' },
            rightPriceScale: { borderColor: '#30363d' }
        });
        
        candleSeries = chart.addCandlestickSeries({
            upColor: '#238636', downColor: '#da3633',
            borderUpColor: '#238636', borderDownColor: '#da3633',
            wickUpColor: '#238636', wickDownColor: '#da3633',
        });
        
        new ResizeObserver(entries => {
            const rect = entries[0].contentRect;
            chart.applyOptions({ width: rect.width, height: rect.height });
        }).observe(container);
    }

    async function loadChartData(symbol) {
        document.getElementById('chart-loader').style.display = 'flex';
        try {
            // Fetch from our new Indexer Endpoint
            // Note: Indexer stores by Symbol (e.g., 'SOL'). 
            // If viewing a generic token, this might be empty until you add it to the 'pools' table.
            const res = await fetch(`${API_URL}/api/history/${symbol}`);
            const data = await res.json();
            
            if (Array.isArray(data) && data.length > 0) {
                // Ensure unique times
                const uniqueData = [];
                const times = new Set();
                data.forEach(d => {
                    if(!times.has(d.time)) {
                        times.add(d.time);
                        uniqueData.push(d);
                    }
                });
                
                candleSeries.setData(uniqueData);
                document.getElementById('chart-loader').style.display = 'none';
            } else {
                document.getElementById('chart-loader').innerText = "No Indexer Data Available for this Pair";
            }
        } catch (e) {
            console.error(e);
            document.getElementById('chart-loader').innerText = "Chart Error";
        }
    }

    function navigateTo(path) {
        document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
        const tableControls = document.getElementById('table-controls');
        const detailControls = document.getElementById('detail-controls');

        if (path === '') {
            document.getElementById('view-dashboard').classList.add('active');
            tableControls.classList.remove('hidden');
            detailControls.classList.add('hidden');
            fetchList();
        } else if (path.startsWith('token/')) {
            const mint = path.split('/')[1];
            currentMint = mint;
            document.getElementById('view-detail').classList.add('active');
            tableControls.classList.add('hidden');
            detailControls.classList.remove('hidden');
            loadTokenDetail(mint);
        }
    }

    async function fetchList() {
        try {
            const res = await fetch(`${API_URL}/api/tokens?page=${currentPage}&limit=50`);
            const data = await res.json();
            if(data.success) renderTable(data.tokens);
        } catch(e) { console.error(e); }
    }

    function renderTable(tokens) {
        const tbody = document.getElementById('table-body');
        tbody.innerHTML = tokens.map(t => `
            <tr onclick="navigateTo('token/${t.mint}')" class="cursor-pointer hover:bg-white/5 transition">
                <td>
                    <div class="flex items-center gap-3">
                        <img src="${t.image || 'https://placehold.co/40'}" class="img-token">
                        <div><div class="text-white font-bold">${t.ticker}</div><div class="text-orange-900 text-xs">${t.name}</div></div>
                    </div>
                </td>
                <td class="text-orange-500 font-bold">${t.kScore || 0}</td>
                <td class="text-white font-mono">$${t.priceUsd?.toFixed(6) || '0.00'}</td>
                <td class="${(t.change24h||0) >= 0 ? 'text-green-500' : 'text-red-500'} font-bold">${(t.change24h||0).toFixed(2)}%</td>
                <td class="text-orange-400 font-mono">$${(t.marketCap||0).toLocaleString()}</td>
                <td class="text-green-600 font-mono">$${(t.volume24h||0).toLocaleString()}</td>
            </tr>
        `).join('');
    }

    async function loadTokenDetail(mint) {
        try {
            const res = await fetch(`${API_URL}/api/token/${mint}`);
            const data = await res.json();
            if(data.success) {
                const t = data.token;
                document.getElementById('detail-ticker').innerText = t.ticker;
                document.getElementById('detail-name').innerText = t.name;
                document.getElementById('detail-img').src = t.image;
                document.getElementById('detail-price').innerText = `$${t.priceUsd?.toFixed(6)}`;
                document.getElementById('detail-vol').innerText = `$${(t.volume24h||0).toLocaleString()}`;
                
                // Load Chart (Using Ticker as Symbol for now)
                loadChartData(t.ticker); 
            }
        } catch(e) { console.error(e); }
    }
    
    function changePage(d) { currentPage += d; if(currentPage<1) currentPage=1; fetchList(); }
    window.handleSearch = (e) => { /* simplified */ };
    lucide.createIcons();
</script>
</body>
</html>
