<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HolDex | The Terminal Fire Explorer</title>
    
    <script src="https://bundle.run/buffer@6.0.3"></script>
    <script>
        if (typeof window.buffer !== 'undefined') {
            window.Buffer = window.buffer.Buffer;
        }
    </script>

    <script src="https://unpkg.com/@solana/web3.js@1.91.0/lib/index.iife.min.js"></script>
    <script src="https://unpkg.com/lightweight-charts@4.1.1/dist/lightweight-charts.standalone.production.js"></script>
    <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://unpkg.com/tweetnacl@1.0.3/nacl-fast.min.js"></script> <!-- Required for signing -->
    <link href="https://fonts.googleapis.com/css2?family=Comic+Neue:wght@400;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        fire: { bg: '#2a1005', panel: '#451a03', border: '#7c2d12', accent: '#ea580c', text: '#ffedd5', highlight: '#fb923c' },
                        void: '#0f0502'
                    },
                    fontFamily: { mono: ['JetBrains Mono', 'monospace'], sans: ['Comic Neue', 'cursive'] }
                }
            }
        }
    </script>
    <style>
        body { background-color: #2a1005; color: #ffedd5; font-family: 'Comic Neue', cursive; min-height: 100vh; font-size: 14px; overflow-x: hidden; padding-bottom: 80px; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #2a1005; }
        ::-webkit-scrollbar-thumb { background: #7c2d12; border-radius: 4px; border: 1px solid #451a03; }
        ::-webkit-scrollbar-thumb:hover { background: #ea580c; }
        nav { background: rgba(42, 16, 5, 0.95); backdrop-filter: blur(12px); border-bottom: 2px solid #7c2d12; }
        .brand-text { color: #ea580c; text-shadow: 2px 2px 0px #451a03; font-weight: 800; letter-spacing: 1px; }
        .holdex-table { width: 100%; border-collapse: separate; border-spacing: 0; }
        .holdex-table th { background: #451a03; position: sticky; top: 0; z-index: 20; padding: 14px 12px; text-align: right; font-size: 12px; font-weight: 700; color: #fb923c; border-bottom: 2px solid #7c2d12; cursor: pointer; white-space: nowrap; text-transform: uppercase; transition: color 0.2s, background 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        .holdex-table th:hover { background: #582206; color: #fff; }
        .holdex-table th:first-child { text-align: left; padding-left: 20px; }
        .holdex-table td { padding: 12px 12px; border-bottom: 1px solid rgba(124, 45, 18, 0.3); vertical-align: middle; font-family: 'JetBrains Mono', monospace; }
        .holdex-table td:first-child { padding-left: 20px; }
        .holdex-table tr:hover td { background: rgba(234, 88, 12, 0.1); }
        .img-token { width: 40px; height: 40px; border-radius: 8px; border: 2px solid #7c2d12; object-fit: cover; flex-shrink: 0; background: #000; }
        .pill { padding: 4px 8px; border-radius: 6px; font-size: 11px; font-weight: 700; font-family: 'JetBrains Mono'; }
        .pill-green { background: rgba(34, 197, 94, 0.15); color: #4ade80; border: 1px solid rgba(34, 197, 94, 0.4); }
        .pill-red { background: rgba(239, 68, 68, 0.15); color: #fca5a5; border: 1px solid rgba(239, 68, 68, 0.4); }
        .search-container { position: relative; width: 100%; }
        .search-box { background: #451a03; border: 2px solid #7c2d12; color: #fb923c; padding: 10px 36px 10px 16px; border-radius: 8px; outline: none; width: 100%; font-family: 'JetBrains Mono'; transition: border-color 0.2s; }
        .search-box:focus { border-color: #ea580c; }
        .search-box::placeholder { color: #9a3412; }
        .clear-search { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); color: #9a3412; cursor: pointer; display: none; }
        .clear-search:hover { color: #ea580c; }
        .nav-btn { background: transparent; color: #9a3412; padding: 8px 20px; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 800; transition: all 0.2s; border: 2px solid transparent; }
        .nav-btn:hover { color: #fb923c; }
        .nav-btn.active { background: #451a03; color: #ea580c; border-color: #7c2d12; box-shadow: 0 4px 0 #2a1005; }
        .filter-toggle { background: #451a03; border: 2px solid #7c2d12; color: #9a3412; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-size: 12px; font-weight: 700; transition: all 0.2s; display: flex; align-items: center; gap: 6px; }
        .filter-toggle.active { border-color: #22c55e; color: #4ade80; background: rgba(34, 197, 94, 0.1); }
        .refresh-btn { background: #451a03; border: 2px solid #7c2d12; color: #fb923c; width: 42px; height: 42px; display: flex; align-items: center; justify-content: center; border-radius: 8px; cursor: pointer; transition: all 0.2s; position: relative; }
        .refresh-btn:hover:not(:disabled) { border-color: #ea580c; color: #fff; background: #582206; }
        .refresh-btn:disabled { opacity: 0.5; cursor: not-allowed; border-color: #451a03; color: #7c2d12; }
        .refresh-btn:disabled i { animation: spin 1s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        .page-btn { background: #2a1005; border: 2px solid #7c2d12; color: #fb923c; padding: 8px 16px; border-radius: 8px; font-weight: bold; font-family: 'JetBrains Mono', monospace; transition: all 0.2s; cursor: pointer; }
        .page-btn:hover:not(:disabled) { border-color: #ea580c; color: #fff; background: #451a03; }
        .page-btn:disabled { opacity: 0.5; cursor: not-allowed; border-color: #451a03; color: #7c2d12; }
        .view-section { display: none; }
        .view-section.active { display: block; animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        
        .chart-wrapper { width: 100%; height: 600px; background: #1a0a05; border-radius: 16px; overflow: hidden; border: 2px solid #7c2d12; box-shadow: 0 10px 30px rgba(0,0,0,0.5); display: flex; flex-direction: column; }
        .chart-header { padding: 12px 16px; background: #2a1005; border-bottom: 1px solid #7c2d12; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 8px; }
        
        .chart-controls-group { display: flex; align-items: center; gap: 4px; background: #0f0502; padding: 4px; border-radius: 8px; border: 1px solid #451a03; }
        
        .res-btn { background: transparent; border: 1px solid transparent; color: #9a3412; padding: 6px 10px; border-radius: 6px; font-family: 'JetBrains Mono'; font-size: 11px; font-weight: bold; cursor: pointer; transition: all 0.1s; }
        .res-btn:hover { color: #fb923c; background: #2a1005; }
        .res-btn.active { background: #451a03; color: #ea580c; border-color: #7c2d12; }
        
        .tool-btn { background: transparent; border: 1px solid transparent; color: #9a3412; padding: 6px 10px; border-radius: 6px; font-family: 'JetBrains Mono'; font-size: 11px; font-weight: bold; cursor: pointer; transition: all 0.1s; display: flex; align-items: center; gap: 4px; }
        .tool-btn:hover { color: #fb923c; background: #2a1005; }
        .tool-btn.active { background: rgba(34, 197, 94, 0.1); color: #4ade80; border-color: rgba(34, 197, 94, 0.3); }
        .tool-btn.active-orange { background: #451a03; color: #ea580c; border-color: #7c2d12; }

        #tv-chart { flex: 1; position: relative; width: 100%; height: 100%; }

        .stat-card { background: rgba(69, 26, 3, 0.8); border: 2px solid #7c2d12; border-radius: 12px; padding: 16px; display: flex; flex-direction: column; gap: 4px; box-shadow: 4px 4px 0 rgba(0,0,0,0.2); }
        .stat-label { font-size: 11px; color: #fb923c; text-transform: uppercase; letter-spacing: 0.05em; font-weight: 700; }
        .stat-value { font-size: 18px; font-weight: 700; color: #fff; font-family: 'JetBrains Mono'; text-shadow: 0 2px 4px rgba(0,0,0,0.5); }
        .stat-card.clickable { cursor: pointer; transition: transform 0.2s, border-color 0.2s; }
        .stat-card.clickable:hover { transform: translateY(-2px); border-color: #ea580c; }
        
        .modal-overlay { position: fixed; inset: 0; background: rgba(15, 5, 2, 0.95); backdrop-filter: blur(5px); z-index: 100; display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: opacity 0.3s; }
        .modal-overlay.open { opacity: 1; pointer-events: auto; }
        .action-btn { background: #451a03; border: 2px solid #ea580c; color: #fb923c; padding: 12px 20px; border-radius: 12px; font-weight: 700; text-transform: uppercase; font-size: 13px; transition: all 0.2s; box-shadow: 4px 4px 0 #7c2d12; }
        .action-btn:hover { transform: translate(-2px, -2px); box-shadow: 6px 6px 0 #7c2d12; background: #582206; color: #fff; }
        .action-btn:active { transform: translate(2px, 2px); box-shadow: 0 0 0; }
        .back-btn { background: #2a1005; border: 2px solid #7c2d12; color: #9a3412; padding: 10px 16px; border-radius: 8px; font-weight: 700; transition: all 0.2s; }
        .back-btn:hover { border-color: #ea580c; color: #ea580c; }
        .sort-header { position: relative; }
        .sort-header:active { transform: translateY(1px); }
        .table-scroll-container { max-height: 70vh; overflow-y: auto; border-radius: 0 0 16px 16px; }
        .form-input { background: #451a03; border: 2px solid #7c2d12; color: #fb923c; padding: 12px; border-radius: 8px; width: 100%; font-family: 'JetBrains Mono'; margin-bottom: 16px; outline: none; transition: border-color 0.2s; }
        .form-input:focus { border-color: #ea580c; }
        .form-label { display: block; color: #9a3412; font-size: 12px; font-weight: bold; margin-bottom: 6px; text-transform: uppercase; }
        .social-btn { display: flex; align-items: center; justify-content: center; width: 42px; height: 42px; border-radius: 12px; border: 2px solid #7c2d12; background: #451a03; color: #ea580c; transition: all 0.2s; }
        .social-btn:hover { border-color: #ea580c; color: #fff; background: #582206; transform: translateY(-2px); }
        .pool-tab { padding: 8px 16px; font-size: 12px; font-weight: bold; color: #9a3412; cursor: pointer; border-bottom: 2px solid transparent; transition: all 0.2s; }
        .pool-tab.active { color: #ea580c; border-bottom-color: #ea580c; background: #2a1005; }
        .pool-tab:hover:not(.active) { color: #fb923c; background: rgba(69, 26, 3, 0.5); }
        .verified-badge { display: inline-flex; align-items: center; justify-content: center; background: rgba(34, 197, 94, 0.15); border: 1px solid #22c55e; color: #22c55e; border-radius: 50%; width: 20px; height: 20px; margin-left: 6px; box-shadow: 0 0 10px rgba(34, 197, 94, 0.3); }
        .verified-badge i { width: 12px; height: 12px; }
        .info-btn { color: #9a3412; cursor: pointer; transition: color 0.2s; }
        .info-btn:hover { color: #fb923c; }
        .info-box { background: #451a03; border: 1px solid #7c2d12; border-radius: 8px; padding: 16px; margin-bottom: 16px; color: #ffedd5; font-size: 13px; line-height: 1.5; }
        .info-box a { color: #fb923c; text-decoration: underline; }
        .feature-box { background: #451a03; border: 2px solid #7c2d12; border-radius: 16px; padding: 24px; transition: transform 0.2s; display: flex; flex-direction: column; gap: 8px; }
        .feature-box:hover { border-color: #ea580c; transform: translateY(-4px); }
        .fee-card { background: rgba(0,0,0,0.3); border: 1px dashed #7c2d12; padding: 12px; border-radius: 8px; margin-bottom: 16px; text-align: center; }
        
        .wallet-btn { background: #2a1005; border: 2px solid #7c2d12; padding: 16px; border-radius: 12px; display: flex; align-items: center; justify-content: space-between; cursor: pointer; transition: all 0.2s; color: #ffedd5; font-weight: bold; }
        .wallet-btn:hover { border-color: #ea580c; background: #451a03; transform: translateX(5px); }
        .wallet-icon { width: 32px; height: 32px; border-radius: 8px; }
        
        .social-btn-lg { display: flex; align-items: center; justify-content: center; width: 56px; height: 56px; border-radius: 14px; border: 2px solid #7c2d12; background: #451a03; color: #ea580c; transition: all 0.2s; }
        .social-btn-lg:hover { border-color: #ea580c; color: #fff; background: #582206; transform: translateY(-2px); }

        .code-block { background: #0f0502; border: 1px solid #7c2d12; padding: 16px; border-radius: 8px; font-family: 'JetBrains Mono', monospace; font-size: 12px; color: #fb923c; overflow-x: auto; position: relative; }
        .code-copy-btn { position: absolute; top: 8px; right: 8px; background: #451a03; border: 1px solid #7c2d12; color: #9a3412; padding: 4px 8px; border-radius: 4px; font-size: 10px; cursor: pointer; transition: all 0.2s; }
        .code-copy-btn:hover { border-color: #ea580c; color: #fff; }
        
        footer { box-shadow: 0 -4px 10px rgba(0,0,0,0.5); }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 6px; }
        .status-dot.online { background: #22c55e; box-shadow: 0 0 5px #22c55e; animation: pulse 2s infinite; }
        .status-dot.offline { background: #ef4444; box-shadow: 0 0 5px #ef4444; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        .footer-wallet-btn { background: #451a03; border: 1px solid #7c2d12; padding: 4px 12px; border-radius: 6px; color: #fb923c; font-weight: bold; font-size: 11px; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 6px; }
        .footer-wallet-btn:hover { border-color: #ea580c; color: #fff; }
        
        .live-indicator { width: 6px; height: 6px; background: #22c55e; border-radius: 50%; display: inline-block; margin-right: 4px; animation: pulse 1s infinite; }
    </style>
</head>
<body>

<nav class="sticky top-0 z-40">
    <div class="max-w-[1800px] mx-auto px-4 md:px-6 py-4 flex flex-col md:flex-row md:justify-between md:items-center gap-4">
        <div class="flex items-center justify-between w-full md:w-auto">
            <div class="flex items-center gap-4 cursor-pointer group" onclick="navigateTo('')">
                <div class="w-12 h-12 rounded-xl flex items-center justify-center bg-[#451a03] text-orange-500 border-2 border-[#7c2d12] shadow-lg group-hover:border-orange-500 transition">
                    <i data-lucide="flame" width="24"></i>
                </div>
                <div>
                    <h1 class="text-3xl brand-text tracking-tight font-sans">HolDex</h1>
                </div>
            </div>
        </div>

        <div class="flex items-center bg-[#451a03]/50 p-1 rounded-lg border border-[#7c2d12]/50">
            <button class="nav-btn active" onclick="navigateTo('')">Home</button>
            <button class="nav-btn" onclick="navigateTo('about')">About</button>
            <button class="nav-btn" onclick="navigateTo('update')">Update</button>
        </div>
        
        <div id="table-controls" class="flex items-center gap-3 w-full md:w-auto transition-opacity duration-300">
            <button id="filter-verified" onclick="toggleVerifiedFilter()" class="filter-toggle" title="Show only Verified Community Updates">
                <i data-lucide="shield-check" width="16"></i> Verified Only
            </button>
            <button id="filter-zerovol" onclick="toggleZeroVolFilter()" class="filter-toggle active" title="Hide tokens with 0 Volume">
                <i data-lucide="bar-chart-2" width="16"></i> Hide 0 Vol
            </button>
            <div class="relative w-full md:w-auto search-container">
                <input type="text" id="search" placeholder="Search..." class="search-box" onkeyup="handleSearch(event)">
                <i id="clear-search-btn" data-lucide="x" width="16" class="clear-search" onclick="clearSearch()"></i>
            </div>
            <button id="manual-refresh" onclick="handleManualRefresh()" class="refresh-btn" title="Refresh Data">
                <i data-lucide="refresh-cw" width="18"></i>
            </button>
        </div>

        <div id="detail-controls" class="hidden w-full md:w-auto">
            <button onclick="navigateTo('')" class="back-btn flex items-center justify-center gap-2 w-full md:w-auto"><i data-lucide="arrow-left" width="16"></i> Back</button>
        </div>
    </div>
</nav>

<main class="max-w-[1800px] mx-auto px-0 md:px-6 py-4 md:py-8">
    
    <!-- DASHBOARD VIEW -->
    <div id="view-dashboard" class="view-section active">
        <div class="bg-[#2a1005] border-y md:border-2 border-[#7c2d12] md:rounded-2xl overflow-hidden shadow-2xl flex flex-col">
            <div class="table-scroll-container overflow-x-auto">
                <table class="holdex-table">
                    <thead>
                        <tr>
                            <th width="30%" class="sort-header" onclick="setSort('newest')">Asset <i data-lucide="arrow-down-up" width="10" class="inline opacity-50 ml-1"></i></th>
                            <th class="sort-header text-[#ea580c] border-b-[#ea580c] border-b-2" onclick="setSort('kscore')">K-Score</th>
                            <th class="hidden md:table-cell sort-header" onclick="setSort('5m')">5m</th>
                            <th class="hidden md:table-cell sort-header" onclick="setSort('1h')">1h</th>
                            <th class="sort-header" onclick="setSort('24h')">24h</th>
                            <th class="sort-header" onclick="setSort('mcap')">Mkt Cap</th>
                            <th class="hidden md:table-cell sort-header" onclick="setSort('holders')">Holders</th>
                            <th class="sort-header" onclick="setSort('volume')">Vol (24h)</th> 
                            <th class="hidden md:table-cell sort-header" onclick="setSort('age')">Age</th>
                        </tr>
                    </thead>
                    <tbody id="table-body">
                        <tr><td colspan="9" class="text-center py-20 text-orange-700 font-mono animate-pulse">Scanning Solana Mempool...</td></tr>
                    </tbody>
                </table>
            </div>
            
            <div class="bg-[#451a03] p-4 border-t-2 border-[#7c2d12] flex justify-between items-center">
                <div class="text-xs text-[#9a3412] font-mono font-bold uppercase tracking-wider hidden md:block">
                    Showing results
                </div>
                <div class="flex items-center gap-4 mx-auto md:mx-0">
                    <button id="btn-prev" onclick="changePage(-1)" class="page-btn flex items-center gap-2" disabled>
                        <i data-lucide="chevron-left" width="16"></i> Previous
                    </button>
                    <span id="page-display" class="text-[#fb923c] font-mono font-bold text-lg">Page 1</span>
                    <button id="btn-next" onclick="changePage(1)" class="page-btn flex items-center gap-2">
                        Next <i data-lucide="chevron-right" width="16"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ABOUT VIEW -->
    <div id="view-about" class="view-section px-4 md:px-0">
        <div class="bg-[#2a1005] border-2 border-[#7c2d12] rounded-2xl p-8 md:p-12 shadow-2xl max-w-5xl mx-auto space-y-12">
            <div class="flex items-center gap-6 border-b-2 border-[#7c2d12] pb-8">
                <div class="w-20 h-20 rounded-2xl flex items-center justify-center bg-[#451a03] text-orange-500 border-2 border-[#7c2d12] shadow-lg flex-shrink-0">
                    <i data-lucide="flame" width="40"></i>
                </div>
                <div>
                    <h2 class="text-5xl font-bold text-white tracking-tight font-sans">About HolDex</h2>
                    <p class="text-[#ea580c] font-mono text-lg mt-1">The High-Velocity Terminal for Solana Assets</p>
                </div>
            </div>
            <div class="grid md:grid-cols-2 gap-8">
                <div>
                    <h3 class="text-2xl font-bold text-white mb-4">Core Philosophy</h3>
                    <p class="text-[#ffedd5] leading-relaxed mb-4">
                        HolDex is built for traders who demand raw speed and absolute truth. We provide a <strong>terminal-grade interface</strong> that cuts through the clutter, now enhanced with <strong>Daily Holder Tracking</strong> and deep historical analysis.
                    </p>
                    <p class="text-[#ffedd5] leading-relaxed">
                        We prioritize <strong>community verification</strong> and <strong>on-chain data integrity</strong>. Our proprietary indexing engine snapshots liquidity pools directly from the Solana RPC, ensuring you see price action as it happens.
                    </p>
                </div>
                <div class="bg-[#451a03] p-6 rounded-xl border border-[#7c2d12] flex flex-col justify-center shadow-inner">
                    <div class="flex items-center gap-3 mb-2"><i data-lucide="server" width="20" class="text-[#22c55e]"></i><span class="font-bold text-white">Direct RPC Sync</span></div>
                    <p class="text-sm text-[#9a3412] mb-4">No third-party delays. We index Raydium and Pump.fun directly.</p>
                    <div class="flex items-center gap-3 mb-2"><i data-lucide="bar-chart" width="20" class="text-[#3b82f6]"></i><span class="font-bold text-white">Holder Analytics</span></div>
                    <p class="text-sm text-[#9a3412]">Track wallet growth over time with our daily snapshot engine.</p>
                </div>
            </div>
            <div class="grid md:grid-cols-3 gap-6">
                <div class="feature-box"><div class="text-[#fb923c] mb-2"><i data-lucide="lock" width="24"></i></div><h4 class="font-bold text-white text-lg">K-Score Protocol</h4><p class="text-sm text-[#9a3412]">Our "Conviction Score" analyzes holder distribution and token velocity to rate asset health.</p></div>
                <div class="feature-box"><div class="text-[#22c55e] mb-2"><i data-lucide="users" width="24"></i></div><h4 class="font-bold text-white text-lg">Community Verified</h4><p class="text-sm text-[#9a3412]">Projects can verify their identity on-chain, earning the green badge and higher visibility.</p></div>
                <div class="feature-box"><div class="text-[#a855f7] mb-2"><i data-lucide="zap" width="24"></i></div><h4 class="font-bold text-white text-lg">Zero Bloat</h4><p class="text-sm text-[#9a3412]">No ads. No trackers. Just data. Built for maximum performance on any device.</p></div>
            </div>
            <div class="bg-[#0f0502] border border-[#7c2d12] rounded-xl p-8 relative overflow-hidden group hover:border-[#ea580c] transition-colors">
                <div class="absolute top-4 right-4 p-4 opacity-10 group-hover:opacity-20 transition-opacity"><i data-lucide="code" width="100" class="text-[#ea580c]"></i></div>
                <h3 class="text-2xl font-bold text-white mb-2">Developers & API</h3>
                <p class="text-[#9a3412] mb-6 max-w-2xl">HolDex exposes a robust public API. You can generate a free API key instantly using your wallet.</p>
                <div class="flex gap-4">
                    <button onclick="toggleApiModal()" class="action-btn flex items-center gap-2"><i data-lucide="file-text" width="16"></i> Documentation</button>
                    <button onclick="requestApiKey()" class="action-btn flex items-center gap-2 bg-[#2a1005] border-[#22c55e] text-[#22c55e] hover:bg-green-900/20"><i data-lucide="key" width="16"></i> Get API Key</button>
                </div>
            </div>
             <div class="border-t border-[#7c2d12] pt-8 flex justify-between items-center text-xs text-[#9a3412]"><div>&copy; 2025 HolDex Protocol. All rights reserved.</div><div class="font-mono">v2.5.0 (Stable)</div></div>
        </div>
    </div>

    <!-- UPDATE VIEW -->
    <div id="view-update" class="view-section px-4 md:px-0">
        <div class="bg-[#2a1005] border-2 border-[#7c2d12] rounded-2xl p-8 shadow-2xl max-w-2xl mx-auto">
            <div class="bg-[#451a03] border-2 border-[#ea580c] rounded-xl p-4 mb-8">
                <div id="wallet-disconnected" class="flex justify-between items-center">
                    <div><h2 class="text-2xl font-bold text-white mb-1 font-sans">Update Token</h2><p class="text-[#9a3412] text-xs">Connect wallet to pay fees & submit updates.</p></div>
                    <button onclick="openWalletModal()" class="action-btn text-xs py-2 px-4 flex items-center gap-2"><i data-lucide="wallet" width="14"></i> Connect</button>
                </div>
                <div id="wallet-connected" class="hidden">
                    <div class="flex justify-between items-start border-b border-[#7c2d12] pb-3 mb-3">
                        <div><div class="text-[#9a3412] text-[10px] font-bold uppercase tracking-wider">Connected Wallet</div><div class="font-mono text-[#fb923c] font-bold text-lg flex items-center gap-2"><span id="display-address">...</span><i data-lucide="check-circle" width="16" class="text-green-500"></i></div></div>
                        <button onclick="disconnectWallet()" class="text-[#9a3412] hover:text-red-500 text-xs font-bold flex items-center gap-1 transition"><i data-lucide="log-out" width="14"></i> Disconnect</button>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-[#2a1005] rounded-lg p-3 border border-[#7c2d12]"><div class="text-[#9a3412] text-[10px] font-bold uppercase">SOL Balance</div><div class="font-mono text-white text-xl" id="balance-sol">0.00</div></div>
                        <div class="bg-[#2a1005] rounded-lg p-3 border border-[#7c2d12]"><div class="text-[#9a3412] text-[10px] font-bold uppercase">$ASDFASDFA Balance</div><div class="font-mono text-[#a855f7] text-xl" id="balance-token">0.00</div></div>
                    </div>
                    <div class="mt-3 text-right"><button onclick="refreshBalances()" class="text-[#ea580c] hover:text-white text-xs font-bold flex items-center justify-end gap-1 w-full"><i id="refresh-icon" data-lucide="refresh-cw" width="12"></i> Refresh Balances</button></div>
                </div>
            </div>

            <div class="fee-card" id="fee-panel">
                <div class="text-[#9a3412] font-bold text-xs uppercase tracking-wider mb-2">Required Fees</div>
                <div class="flex justify-center gap-6 items-center">
                    <div class="flex flex-col"><span class="text-xl font-mono text-[#fb923c]" id="fee-sol">-- SOL</span><span class="text-[10px] text-[#9a3412] text-center">Protocol Fee</span></div>
                    <div class="text-[#7c2d12]">+</div>
                    <div class="flex flex-col"><span class="text-xl font-mono text-[#a855f7]" id="fee-token">-- TOKENS</span><span class="text-[10px] text-[#9a3412] text-center">$ASDFASDFA</span></div>
                </div>
            </div>
            
            <form onsubmit="submitUpdate(event)">
                <label class="form-label">Token Mint Address</label>
                <div class="relative"><input type="text" id="update-mint" class="form-input" placeholder="Enter Solana Mint Address..." required onblur="fetchTokenForUpdate(this.value)"><div id="mint-check-spinner" class="absolute right-3 top-3 hidden"><i data-lucide="loader-2" class="animate-spin text-[#ea580c]" width="18"></i></div></div>
                <div id="token-preview-info" class="mb-6 p-4 bg-[#451a03] border border-[#7c2d12] rounded-lg hidden flex items-center gap-4"><img id="update-token-img" src="" class="w-12 h-12 rounded-md object-cover bg-black"><div><div class="font-bold text-white" id="update-token-name">Token Name</div><div class="text-xs text-[#9a3412] font-mono" id="update-token-ticker">TICKER</div></div></div>
                <div class="grid grid-cols-2 gap-4"><div><label class="form-label">X (Twitter)</label><input type="url" id="update-twitter" class="form-input" placeholder="https://x.com/..."></div><div><label class="form-label">Telegram</label><input type="url" id="update-telegram" class="form-input" placeholder="https://t.me/..."></div></div>
                <label class="form-label">Website</label><input type="url" id="update-website" class="form-input" placeholder="https://...">
                <div class="mt-2"><label class="form-label">Description (Max 250 chars)</label><textarea id="update-description" class="form-input h-24 resize-none" maxlength="250" placeholder="Briefly describe your token project..."></textarea><div class="text-right text-[10px] text-[#9a3412] font-mono font-bold"><span id="char-count">0</span>/250</div></div>
                <div class="flex justify-between items-center mb-1 mt-2"><label class="form-label mb-0">Banner Image URL</label><button type="button" class="info-btn flex items-center gap-1 text-xs" onclick="toggleInfoModal()"><i data-lucide="help-circle" width="14"></i> How to upload?</button></div>
                <input type="url" id="update-banner" class="form-input" placeholder="https://i.imgur.com/...">
                <div class="flex gap-4 mt-6"><button type="button" onclick="openPreview()" class="action-btn flex-1 flex items-center justify-center gap-2 bg-[#451a03] text-[#fb923c] border-[#ea580c] hover:bg-[#582206]"><i data-lucide="eye" width="16"></i> Preview</button><button type="submit" id="submit-btn" class="action-btn flex-1 flex items-center justify-center gap-2 bg-[#2a1005] border-[#22c55e] text-[#22c55e] hover:bg-green-900/20 disabled:opacity-50 disabled:cursor-not-allowed" disabled><i data-lucide="wallet" width="16"></i> Pay & Submit</button></div>
            </form>
            <div id="update-status" class="mt-4 text-center text-sm font-mono hidden"></div>
        </div>
    </div>

    <!-- DETAIL VIEW -->
    <div id="view-detail" class="view-section px-4 md:px-0">
        <div id="detail-loading" class="text-center py-20 text-[#ea580c] font-mono animate-pulse hidden">Fetching Chain Data...</div>
        <div id="detail-content" style="display: none;">
            <!-- DYNAMIC BANNER -->
            <div id="detail-banner-container" class="hidden mb-6"></div>

            <div class="flex flex-col md:flex-row gap-6 mb-8 items-start">
                <div class="flex items-center gap-6 w-full md:w-auto bg-[#451a03] p-4 rounded-2xl border-2 border-[#7c2d12] shadow-xl">
                    <div id="detail-media-container" class="flex-shrink-0"><img class="w-20 h-20 rounded-xl border-2 border-[#ea580c] object-cover bg-black shadow-lg"></div>
                    <div class="flex-1 min-w-0">
                        <div class="flex flex-col md:flex-row md:items-center gap-2 md:gap-3 mb-1"><h2 id="detail-ticker" class="text-3xl md:text-4xl font-bold text-white tracking-tight truncate font-mono"></h2><span id="detail-name" class="text-[#fb923c] text-xs md:text-sm bg-[#2a1005] px-3 py-1 rounded-lg border border-[#7c2d12] truncate"></span></div>
                        <div class="flex items-center gap-2 cursor-pointer group" onclick="copyMint()"><span id="detail-mint" class="text-xs text-[#9a3412] font-mono group-hover:text-[#ea580c] transition truncate max-w-[200px] md:max-w-none"></span><i data-lucide="copy" width="12" class="text-[#9a3412] group-hover:text-[#ea580c] flex-shrink-0"></i></div>
                        <!-- DESCRIPTION -->
                        <div id="detail-desc" class="mt-3 text-sm text-[#ffedd5] font-sans leading-relaxed opacity-90 hidden max-w-lg"></div>
                    </div>
                </div>
                <div class="flex-1"></div>
                <div class="flex flex-wrap gap-3 w-full md:w-auto items-center justify-end" id="detail-actions"></div>
            </div>
            
            <div class="grid grid-cols-2 lg:grid-cols-6 gap-3 md:gap-4 mb-6">
                <!-- NEW: K-Score Logic -->
                <div class="stat-card border-[#ea580c] relative overflow-hidden"><span class="stat-label text-[#ea580c]">K-Score</span><span id="stat-kscore" class="stat-value text-[#fb923c] text-2xl font-bold font-mono">ðŸ”’</span></div>
                
                <div class="stat-card"><span class="stat-label flex items-center gap-1">Price <span class="live-indicator ml-1"></span></span><span id="stat-price" class="stat-value text-[#ffedd5]">-</span></div>
                <div class="stat-card"><span class="stat-label">MCap</span><span id="stat-mcap" class="stat-value text-[#ea580c]">-</span></div>
                
                <!-- NEW: Holders Stat with Click Action -->
                <div class="stat-card clickable hover:bg-[#582206]" onclick="openHolderHistory()"><span class="stat-label flex items-center gap-1">Holders <i data-lucide="bar-chart" width="12"></i></span><span id="stat-holders" class="stat-value text-[#3b82f6]">-</span></div>
                
                <div class="stat-card"><span class="stat-label">1H</span><span id="stat-chg1h" class="stat-value">-</span></div>
                <div class="stat-card"><span class="stat-label">24H</span><span id="stat-chg24h" class="stat-value">-</span></div>
            </div>
            
            <div class="flex justify-between items-center border-b border-[#7c2d12] mb-4 pb-2">
                <div class="flex items-center gap-2">
                    <div class="text-[#fb923c] font-bold font-mono text-sm flex items-center gap-2"><i data-lucide="activity" width="16"></i> INTERNAL FEED <span id="chart-pool-name" class="text-xs text-[#9a3412] ml-2"></span></div>
                </div>
                <button onclick="toggleLpModal()" class="text-xs text-[#9a3412] hover:text-[#fb923c] font-bold font-mono flex items-center gap-1 border border-[#7c2d12] px-2 py-1 rounded bg-[#2a1005] hover:border-[#ea580c]">
                    <i data-lucide="layers" width="12"></i> View LP Details
                </button>
            </div>
            
            <div class="chart-wrapper">
                <div class="chart-header">
                     <!-- CHART MODE TOGGLE -->
                     <div class="flex flex-wrap items-center gap-4 w-full md:w-auto">
                        <div class="chart-controls-group">
                            <button onclick="setChartMode('price')" class="tool-btn active-orange" id="mode-price">Price</button>
                            <button onclick="setChartMode('mcap')" class="tool-btn" id="mode-mcap">M.Cap</button>
                        </div>

                        <div class="chart-controls-group">
                            <button onclick="toggleScale()" class="tool-btn" id="btn-scale">
                                <i data-lucide="scaling" width="12"></i> <span id="scale-text">Linear</span>
                            </button>
                        </div>
                     </div>
                     
                     <div class="chart-controls-group ml-auto">
                         <button onclick="setResolution('5')" class="res-btn active" id="res-5">5m</button>
                         <button onclick="setResolution('15')" class="res-btn" id="res-15">15m</button>
                         <button onclick="setResolution('60')" class="res-btn" id="res-60">1H</button>
                         <button onclick="setResolution('240')" class="res-btn" id="res-240">4H</button>
                         <button onclick="setResolution('D')" class="res-btn" id="res-D">1D</button>
                     </div>
                </div>
                <div id="tv-chart" style="width: 100%; height: 100%;"></div>
            </div>
        </div>
    </div>
</main>

<!-- NEW: STATUS FOOTER -->
<footer class="fixed bottom-0 w-full bg-[#1a0a05] border-t border-[#7c2d12] px-4 py-2 z-50 flex justify-between items-center text-xs font-mono">
    <div class="flex items-center gap-4">
        <div class="flex items-center gap-2">
            <span id="footer-status-dot" class="status-dot offline"></span>
            <span id="footer-status-text" class="text-[#9a3412]">Connecting...</span>
        </div>
        <div class="hidden md:block text-[#9a3412]">|</div>
        <div class="hidden md:block text-[#9a3412]">
            Last Update: <span id="footer-last-update" class="text-[#fb923c] font-bold">--:--:--</span>
        </div>
    </div>
    
    <!-- Footer Wallet Widget -->
    <div class="flex items-center gap-3">
        <div id="footer-wallet-display" class="hidden items-center gap-2">
            <span class="text-[#22c55e] font-bold flex items-center gap-1"><i data-lucide="check-circle" width="10"></i> Connected</span>
            <span class="text-[#9a3412]">|</span>
            <button onclick="disconnectWallet()" class="text-[#ef4444] hover:text-[#f87171] font-bold">Disconnect</button>
        </div>
        <button id="footer-connect-btn" onclick="openWalletModal()" class="footer-wallet-btn">
            <i data-lucide="wallet" width="12"></i> Connect Wallet
        </button>
    </div>
</footer>

<!-- API DOCUMENTATION MODAL (UPDATED) -->
<div id="api-docs-modal" class="modal-overlay" onclick="toggleApiModal()">
    <div class="bg-[#2a1005] border-2 border-[#7c2d12] rounded-2xl p-6 w-full max-w-4xl max-h-[90vh] overflow-y-auto relative shadow-2xl" onclick="event.stopPropagation()">
        <button class="absolute top-4 right-4 text-[#9a3412] hover:text-white" onclick="toggleApiModal()"><i data-lucide="x" width="24"></i></button>
        <div class="flex items-center gap-3 mb-6">
            <div class="p-2 bg-[#451a03] rounded-lg border border-[#7c2d12] text-[#ea580c]"><i data-lucide="terminal" width="24"></i></div>
            <div>
                <h3 class="text-xl font-bold text-white font-sans">HolDex API Reference</h3>
                <p class="text-xs text-[#9a3412] font-mono">Base URL: https://asdev-backend.onrender.com</p>
            </div>
        </div>

        <div class="bg-[#0f0502] border border-[#7c2d12] p-4 rounded-lg mb-6">
            <h4 class="text-[#ea580c] font-bold mb-2 text-sm">Authentication</h4>
            <p class="text-xs text-[#ffedd5] mb-2">Include your API Key in the request header:</p>
            <div class="code-block text-xs py-2 px-3">x-api-key: YOUR_KEY_HERE</div>
            <p class="text-[10px] text-[#9a3412] mt-2 italic">Free Tier Limit: 1,000 requests/day</p>
        </div>

        <div class="space-y-8">
            <!-- ENDPOINT 1 -->
            <div>
                <div class="flex items-center gap-2 mb-2"><span class="px-2 py-1 rounded bg-green-900/30 text-green-500 text-xs font-bold font-mono border border-green-500/30">GET</span> <span class="text-[#fb923c] font-mono font-bold">/api/tokens</span></div>
                <p class="text-sm text-[#ffedd5] mb-2">Fetch a paginated list of tokens indexed by the protocol. Now includes <strong>holder counts</strong>.</p>
                <div class="code-block">
<span class="text-[#9a3412]">// Example Response Object</span>
{
  "mint": "So111...",
  "ticker": "SOL",
  "holders": 5420,
  "kScore": 85.5,
  ...
}
                </div>
            </div>

            <!-- ENDPOINT 2 -->
            <div>
                <div class="flex items-center gap-2 mb-2"><span class="px-2 py-1 rounded bg-green-900/30 text-green-500 text-xs font-bold font-mono border border-green-500/30">GET</span> <span class="text-[#fb923c] font-mono font-bold">/api/token/:mint</span></div>
                <p class="text-sm text-[#ffedd5] mb-2">Get detailed metadata, price stats, pool information, and <strong>daily holder history snapshots</strong>.</p>
                <div class="code-block">
<span class="text-[#9a3412]">// Example Request</span>
fetch('<span class="text-white">https://asdev-backend.onrender.com/api/token/So111...11112</span>');
                </div>
            </div>

            <!-- ENDPOINT 3 -->
            <div>
                <div class="flex items-center gap-2 mb-2"><span class="px-2 py-1 rounded bg-green-900/30 text-green-500 text-xs font-bold font-mono border border-green-500/30">GET</span> <span class="text-[#fb923c] font-mono font-bold">/api/token/:mint/candles</span></div>
                <p class="text-sm text-[#ffedd5] mb-2">Fetch OHLCV candle data for charting. Returns data from the most liquid pool by default.</p>
                <div class="code-block">
<span class="text-[#9a3412]">// Example Request</span>
fetch('<span class="text-white">.../api/token/:mint/candles?resolution=60&from=1700000000&to=1700086400</span>');
                </div>
            </div>
        </div>
        
        <div class="mt-8 flex justify-end">
             <button onclick="toggleApiModal()" class="action-btn text-xs">Close Documentation</button>
        </div>
    </div>
</div>

<!-- LP DETAILS MODAL -->
<div id="lp-modal" class="modal-overlay" onclick="toggleLpModal()">
    <div class="bg-[#2a1005] border-2 border-[#7c2d12] rounded-2xl p-6 w-full max-w-2xl max-h-[80vh] overflow-y-auto relative shadow-2xl" onclick="event.stopPropagation()">
        <button class="absolute top-4 right-4 text-[#9a3412] hover:text-white" onclick="toggleLpModal()"><i data-lucide="x" width="24"></i></button>
        <h3 class="text-xl font-bold text-white mb-6 font-sans">Liquidity Pools</h3>
        <div class="overflow-x-auto">
            <table class="w-full text-left text-sm text-[#ffedd5]">
                <thead class="text-[#9a3412] uppercase text-xs font-bold border-b border-[#7c2d12]">
                    <tr>
                        <th class="px-4 py-3">DEX</th>
                        <th class="px-4 py-3 text-right">Price</th>
                        <th class="px-4 py-3 text-right">Liquidity</th>
                        <th class="px-4 py-3 text-right">Vol 24h</th>
                        <th class="px-4 py-3"></th>
                    </tr>
                </thead>
                <tbody id="lp-list-body">
                    <!-- Populated via JS -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<div id="wallet-modal" class="modal-overlay">
    <div class="bg-[#2a1005] border-2 border-[#ea580c] p-6 rounded-2xl max-w-sm w-full shadow-2xl relative" onclick="event.stopPropagation()">
        <button class="absolute top-4 right-4 text-[#9a3412] hover:text-white" onclick="closeWalletModal()"><i data-lucide="x" width="24"></i></button>
        <h3 class="text-xl font-bold text-white mb-6 font-sans text-center">Connect Wallet</h3>
        <div class="space-y-3">
            <div onclick="connectProvider('phantom')" class="wallet-btn group"><div class="flex items-center gap-3"><div class="w-8 h-8 rounded bg-[#581c87] flex items-center justify-center"><i data-lucide="ghost" width="20" class="text-white"></i></div><span>Phantom</span></div><div class="text-[#22c55e] text-xs font-mono opacity-0 group-hover:opacity-100 transition">Detected</div></div>
            <div onclick="connectProvider('solflare')" class="wallet-btn group"><div class="flex items-center gap-3"><div class="w-8 h-8 rounded bg-[#ea580c] flex items-center justify-center"><i data-lucide="flame" width="20" class="text-white"></i></div><span>Solflare</span></div><div class="text-[#22c55e] text-xs font-mono opacity-0 group-hover:opacity-100 transition">Detected</div></div>
        </div>
    </div>
</div>

<!-- INFO MODAL -->
<div id="info-modal" class="modal-overlay" onclick="toggleInfoModal()">
    <div class="bg-[#2a1005] border-2 border-[#7c2d12] p-6 rounded-2xl max-w-md w-full shadow-2xl relative" onclick="event.stopPropagation()">
        <button class="absolute top-4 right-4 text-[#9a3412] hover:text-white" onclick="toggleInfoModal()"><i data-lucide="x" width="24"></i></button>
        <h3 class="text-xl font-bold text-white mb-4 font-sans">How to upload a Banner?</h3>
        <ol class="list-decimal list-inside text-[#ffedd5] space-y-3 mb-6 font-mono text-sm">
            <li>Go to <a href="https://imgur.com/upload" target="_blank" class="text-[#ea580c] underline hover:text-[#fb923c]">imgur.com/upload</a></li>
            <li>Upload your banner image (Rec: 1500x500px).</li>
            <li>Right-click the uploaded image and select <strong>"Copy Image Address"</strong>.</li>
            <li>Paste the URL here. It must end in .jpg, .png, .webp, .gif.</li>
        </ol>
        <div class="bg-[#451a03] p-3 rounded border border-[#7c2d12] text-xs text-[#9a3412]">
            <strong>Note:</strong> We do not host images directly to keep the protocol decentralized and lightweight.
        </div>
    </div>
</div>

<!-- PREVIEW MODAL -->
<div id="preview-modal" class="modal-overlay">
    <div class="bg-[#2a1005] border-2 border-[#7c2d12] rounded-2xl p-6 w-full max-w-4xl max-h-[90vh] overflow-y-auto relative shadow-2xl" onclick="event.stopPropagation()">
        <button class="absolute top-4 right-4 text-[#9a3412] hover:text-white z-50" onclick="closePreview()"><i data-lucide="x" width="24"></i></button>
        <h3 class="text-xl font-bold text-white mb-6 font-sans">Preview Changes</h3>
        <div id="preview-container"></div>
        <div class="mt-8 flex justify-end">
             <button onclick="closePreview()" class="action-btn text-xs">Close Preview</button>
        </div>
    </div>
</div>

<!-- NEW: HOLDER HISTORY MODAL -->
<div id="holder-modal" class="modal-overlay">
    <div class="bg-[#2a1005] border-2 border-[#7c2d12] rounded-2xl p-6 w-full max-w-2xl max-h-[80vh] relative shadow-2xl" onclick="event.stopPropagation()">
        <button class="absolute top-4 right-4 text-[#9a3412] hover:text-white" onclick="closeHolderHistory()"><i data-lucide="x" width="24"></i></button>
        <h3 class="text-xl font-bold text-white mb-2 font-sans">Holder Growth</h3>
        <p class="text-xs text-[#9a3412] mb-6 font-mono">Daily snapshots</p>
        <div id="holder-chart-container" class="w-full h-64 bg-[#1a0a05] rounded-xl border border-[#7c2d12] overflow-hidden"></div>
    </div>
</div>

<!-- NEW: GENERATED KEY MODAL -->
<div id="key-modal" class="modal-overlay">
    <div class="bg-[#2a1005] border-2 border-[#ea580c] rounded-2xl p-8 w-full max-w-md relative shadow-2xl text-center" onclick="event.stopPropagation()">
        <button class="absolute top-4 right-4 text-[#9a3412] hover:text-white" onclick="closeKeyModal()"><i data-lucide="x" width="24"></i></button>
        <div class="w-12 h-12 bg-[#451a03] rounded-full flex items-center justify-center mx-auto mb-4 border border-[#ea580c] text-[#ea580c]"><i data-lucide="key" width="24"></i></div>
        <h3 class="text-2xl font-bold text-white mb-2 font-sans">Your API Key</h3>
        <p class="text-xs text-[#9a3412] mb-6">Keep this safe. It allows 1,000 reqs/day.</p>
        
        <div class="bg-[#0f0502] border border-[#7c2d12] p-4 rounded-lg mb-6 relative">
            <div id="generated-key-display" class="font-mono text-[#fb923c] text-lg break-all">...</div>
            <button onclick="copyKey()" class="absolute top-2 right-2 text-[#9a3412] hover:text-white"><i data-lucide="copy" width="16"></i></button>
        </div>
        
        <button onclick="closeKeyModal()" class="action-btn w-full justify-center">Done</button>
    </div>
</div>

<script>
    const API_URL = 'https://asdev-backend.onrender.com';
    const FALLBACK_BANNER = "https://images.squarespace-cdn.com/content/690b8c21384b3f1201c2650c/967ea61f-a88a-4497-81c2-5c67d3d06d9e/Gemini_Generated_Image_c82gwyc82gwyc82g.png?content-type=image%2Fpng";
    const TOKEN_PROGRAM_ID = new solanaWeb3.PublicKey('TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA');
    const ASSOCIATED_TOKEN_PROGRAM_ID = new solanaWeb3.PublicKey('ATokenGPvbdGVxr1b2hvZbsiqW5xWH25efTNsLJA8knL');
    
    // We removed client-side RPC ENDPOINTS. All traffic now proxies through backend.

    let currentSort = 'kscore'; 
    let searchQuery = '';
    let pollingInterval;
    let detailPollingInterval; 
    let isConnected = true;
    let isInfoModalOpen = false;
    let isApiModalOpen = false;
    let isLpModalOpen = false;
    let isWalletModalOpen = false;
    let currentPage = 1;
    let isVerifiedFilter = false;
    let isZeroVolHidden = true; 
    let currentUpdateTokenData = null;
    let walletAddress = null;
    let walletProvider = null; 
    let feeConfig = { solFee: 0.1, tokenFee: 1000, tokenMint: '9zB5wRarXMj86MymwLumSKA1Dx35zPqqKfcZtK1Spump', treasury: 'H8sMJqC9X8rJ8W1a6VjFq7X5gZ5fX9x8x8x8x8x8x8' };
    
    // CHART STATE
    let chartInstance = null;
    let candleSeries = null;
    let maSeries20 = null;
    let maSeries50 = null;
    let currentMint = null;
    let currentPoolAddress = null;
    let currentResolution = '60';
    let currentChartMode = 'price'; // 'price' or 'mcap'
    let currentNormalizedSupply = 1;
    let currentTokenPairs = [];
    
    let isLogScale = false;
    let showMA = false;

    // HOLDER CHART STATE
    let currentHolderHistory = [];
    let holderChart = null;
    let holderAreaSeries = null;

    // SOCKET.IO CLIENT
    let socket = null;

    window.onload = async () => { 
        handleRoute(); 
        await fetchFees(); 
        lucide.createIcons(); 
        
        // Initialize Socket
        socket = io(API_URL, { path: '/socket.io', transports: ['websocket'] });
        socket.on('connect', () => {
            const dot = document.getElementById('footer-status-dot');
            const txt = document.getElementById('footer-status-text');
            if(dot) { dot.classList.remove('offline'); dot.classList.add('online'); }
            if(txt) txt.innerText = "System Online (Live)";
        });
        socket.on('disconnect', () => {
            const dot = document.getElementById('footer-status-dot');
            const txt = document.getElementById('footer-status-text');
            if(dot) { dot.classList.add('offline'); dot.classList.remove('online'); }
            if(txt) txt.innerText = "Disconnected";
        });

        // Handle Real-Time Updates
        socket.on('update', (data) => {
            if (currentMint && window.location.hash.startsWith(`#token/${currentMint}`)) {
                // We are viewing this token, update stats safely
                updateLiveStats(data);
            }
        });

        const descInput = document.getElementById('update-description'); 
        const charCount = document.getElementById('char-count'); 
        if(descInput && charCount) { 
            descInput.addEventListener('input', () => { charCount.innerText = descInput.value.length; }); 
        } 
    };
    
    window.addEventListener('hashchange', handleRoute);

    // --- LIVE UPDATES ---
    function updateLiveStats(data) {
        // Safe Update Function
        const safeSetText = (id, txt) => { const el = document.getElementById(id); if(el) el.innerText = txt; };
        const safeSetHTML = (id, htm) => { const el = document.getElementById(id); if(el) el.innerHTML = htm; };

        // Update main stats
        safeSetText('stat-price', formatMoney(data.priceUsd));
        safeSetText('stat-mcap', formatCompact(data.marketCap));
        safeSetText('stat-vol', formatCompact(data.volume24h));
        safeSetHTML('stat-chg1h', formatPct(data.change1h));
        safeSetHTML('stat-chg24h', formatPct(data.change24h));
        safeSetText('stat-holders', (data.holders || 0).toLocaleString());

        // Update footer time
        const time = document.getElementById('footer-last-update');
        if(time) time.innerText = new Date().toLocaleTimeString();
    }

    // --- CHART LOGIC UPDATED ---
    function cleanupChart() {
        if (chartInstance) { chartInstance.remove(); chartInstance = null; candleSeries = null; maSeries20 = null; maSeries50 = null; }
        document.getElementById('tv-chart').innerHTML = '';
    }

    function initChart() {
        if (chartInstance) return;
        const container = document.getElementById('tv-chart');
        if (!container) return;
        const rect = container.getBoundingClientRect();
        if (rect.width === 0 || rect.height === 0) return;

        chartInstance = LightweightCharts.createChart(container, {
            width: rect.width,
            height: rect.height,
            layout: { background: { type: 'solid', color: '#1a0a05' }, textColor: '#9a3412' },
            grid: { vertLines: { color: '#2a1005' }, horzLines: { color: '#2a1005' } },
            crosshair: { mode: LightweightCharts.CrosshairMode.Normal },
            rightPriceScale: { borderColor: '#7c2d12', mode: isLogScale ? LightweightCharts.PriceScaleMode.Logarithmic : LightweightCharts.PriceScaleMode.Normal },
            timeScale: { borderColor: '#7c2d12', timeVisible: true, secondsVisible: false }
        });
        
        candleSeries = chartInstance.addCandlestickSeries({ upColor: '#22c55e', downColor: '#ef4444', borderVisible: false, wickUpColor: '#22c55e', wickDownColor: '#ef4444' });
        
        // Add MA Series (Hidden by default until data populates)
        maSeries20 = chartInstance.addLineSeries({ color: '#fb923c', lineWidth: 1, crosshairMarkerVisible: false }); // Orange
        maSeries50 = chartInstance.addLineSeries({ color: '#3b82f6', lineWidth: 2, crosshairMarkerVisible: false }); // Blue

        new ResizeObserver(entries => {
            if (entries.length > 0 && chartInstance) {
                 const { width, height } = entries[0].contentRect;
                 chartInstance.applyOptions({ width, height });
            }
        }).observe(container);
    }

    async function setResolution(res) {
        currentResolution = res;
        document.querySelectorAll('.res-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(`res-${res}`).classList.add('active');
        if (currentMint) await fetchCandles(currentMint, currentPoolAddress);
    }
    
    function toggleScale() {
        if (!chartInstance) return;
        isLogScale = !isLogScale;
        
        const btn = document.getElementById('btn-scale');
        const txt = document.getElementById('scale-text');
        
        if (isLogScale) {
            btn.classList.add('active');
            txt.innerText = 'Log';
            chartInstance.priceScale('right').applyOptions({ mode: LightweightCharts.PriceScaleMode.Logarithmic });
        } else {
            btn.classList.remove('active');
            txt.innerText = 'Linear';
            chartInstance.priceScale('right').applyOptions({ mode: LightweightCharts.PriceScaleMode.Normal });
        }
    }
    
    // Removed toggleMA function

    function calculateSMA(data, count) {
        const avg = (series) => {
            let sum = 0;
            for (let i = 0; i < series.length; i++) { sum += series[i].close; }
            return sum / series.length;
        };
        const result = [];
        for (let i = count - 1, len = data.length; i < len; i++) {
            const val = avg(data.slice(i - count + 1, i + 1));
            result.push({ time: data[i].time, value: val });
        }
        return result;
    }

    async function setChartMode(mode) {
        if (currentChartMode === mode) return;
        currentChartMode = mode;
        document.getElementById('mode-price').classList.toggle('active-orange', mode === 'price');
        document.getElementById('mode-mcap').classList.toggle('active-orange', mode === 'mcap');
        if (currentMint) await fetchCandles(currentMint, currentPoolAddress);
    }

    async function fetchCandles(mint, poolAddress = null) {
        if (!mint) return;
        currentMint = mint;
        currentPoolAddress = poolAddress;
        
        initChart();
        if (!chartInstance || !candleSeries) return;

        try {
            const now = Math.floor(Date.now() / 1000);
            
            // INCREASED DEFAULT LOOKBACK (Fetch Deep History)
            let lookback = 30 * 24 * 60 * 60; // Base: 30 days
            
            if (currentResolution === '5') lookback = 3 * 24 * 60 * 60; // 3 Days for 5m
            if (currentResolution === '15') lookback = 7 * 24 * 60 * 60; // 7 Days for 15m
            if (currentResolution === '60') lookback = 30 * 24 * 60 * 60; // 30 Days for 1H
            if (currentResolution === '240') lookback = 90 * 24 * 60 * 60; // 90 Days for 4H
            if (currentResolution === 'D') lookback = 365 * 24 * 60 * 60; // 1 Year for 1D
            
            let from = now - lookback;

            let endpoint = `${API_URL}/api/token/${mint}/candles?resolution=${currentResolution}&from=${from}&to=${now}`;
            if (poolAddress) endpoint += `&poolAddress=${poolAddress}`;
            endpoint += `&_=${Date.now()}`;
            
            const res = await fetch(endpoint);
            const data = await res.json();
            
            if (data.success && Array.isArray(data.candles)) {
                // ROBUST DATA CLEANING (Fixes "Value is Null")
                // 1. Map and Parse
                // 2. Filter invalid numbers/NaN/nulls
                // 3. Sort by Time Ascending
                // 4. Deduplicate Times
                let cleanData = data.candles.map(c => {
                    let open = parseFloat(c.open);
                    let high = parseFloat(c.high);
                    let low = parseFloat(c.low);
                    let close = parseFloat(c.close);
                    let time = parseInt(c.time);
                    
                    // Filter out bad data points that crash the chart
                    if (!time || isNaN(open) || isNaN(high) || isNaN(low) || isNaN(close)) return null;

                    if (currentChartMode === 'mcap') {
                        open *= currentNormalizedSupply;
                        high *= currentNormalizedSupply;
                        low *= currentNormalizedSupply;
                        close *= currentNormalizedSupply;
                    }

                    return { time: time, open, high, low, close };
                })
                .filter(c => c !== null)
                .sort((a,b) => a.time - b.time); // Lightweight charts STRICTLY requires ascending order

                // Deduplicate (Duplicate times crash the chart)
                const uniqueData = [];
                const seenTimes = new Set();
                for (const d of cleanData) {
                    if (!seenTimes.has(d.time)) {
                        seenTimes.add(d.time);
                        uniqueData.push(d);
                    }
                }
                
                chartInstance.applyOptions({
                    rightPriceScale: {
                        autoScale: true,
                        format: {
                            type: currentChartMode === 'mcap' ? 'volume' : 'price',
                            precision: currentChartMode === 'mcap' ? 0 : 6,
                            minMove: currentChartMode === 'mcap' ? 1 : 0.000001,
                        }
                    }
                });

                candleSeries.setData(uniqueData);
                
                // Always fit content on load if data exists
                if (uniqueData.length > 0) {
                     chartInstance.timeScale().fitContent();
                }
            } else if (candleSeries) {
                candleSeries.setData([]);
            }
        } catch (e) { console.error("Chart Fetch Failed", e); }
    }

    // --- HOLDER CHART LOGIC ---
    function openHolderHistory() {
        document.getElementById('holder-modal').classList.add('open');
        initHolderChart();
    }
    
    function closeHolderHistory() {
        document.getElementById('holder-modal').classList.remove('open');
    }
    
    // NEW FUNCTION: Cleanup old holder charts
    function cleanupHolderChart() {
        if (holderChart) {
            holderChart.remove();
            holderChart = null;
            holderAreaSeries = null;
        }
        document.getElementById('holder-chart-container').innerHTML = '';
    }

    function initHolderChart() {
        const container = document.getElementById('holder-chart-container');
        if(!container || holderChart) return;
        
        const rect = container.getBoundingClientRect();
        holderChart = LightweightCharts.createChart(container, {
            width: rect.width,
            height: rect.height,
            layout: { background: { type: 'solid', color: '#1a0a05' }, textColor: '#9a3412' },
            grid: { vertLines: { color: '#2a1005' }, horzLines: { color: '#2a1005' } },
            rightPriceScale: { borderVisible: false },
            timeScale: { borderVisible: false, timeVisible: true }
        });
        
        holderAreaSeries = holderChart.addAreaSeries({ 
            lineColor: '#3b82f6', 
            topColor: 'rgba(59, 130, 246, 0.4)', 
            bottomColor: 'rgba(59, 130, 246, 0.0)',
            lineWidth: 2
        });
        
        if (currentHolderHistory.length > 0) {
            const data = currentHolderHistory.map(h => ({
                time: h.timestamp / 1000,
                value: h.count
            }));
            // Sort by time
            data.sort((a,b) => a.time - b.time);
            
            // De-duplicate time
            const uniqueData = [];
            let lastTime = 0;
            for(const p of data) {
                 if (p.time > lastTime) {
                     uniqueData.push(p);
                     lastTime = p.time;
                 }
            }
            holderAreaSeries.setData(uniqueData);
            holderChart.timeScale().fitContent();
        }
    }

    // --- API KEY GENERATION LOGIC ---
    async function requestApiKey() {
        if (!walletAddress || !walletProvider) {
            alert("Please connect your wallet first.");
            openWalletModal();
            return;
        }

        try {
            const message = "Request HolDex API Key";
            const encodedMessage = new TextEncoder().encode(message);
            const signedMessage = await walletProvider.signMessage(encodedMessage, 'utf8');
            
            // Handle different wallet signature formats
            let signatureBase64;
            if (signedMessage.signature) {
                // Phantom/Solflare often return object with signature property
                signatureBase64 = window.buffer.Buffer.from(signedMessage.signature).toString('base64');
            } else {
                // Standard byte array
                signatureBase64 = window.buffer.Buffer.from(signedMessage).toString('base64');
            }

            const res = await fetch(`${API_URL}/api/request-api-key`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ wallet: walletAddress, signature: signatureBase64 })
            });

            const data = await res.json();
            if (data.success) {
                document.getElementById('generated-key-display').innerText = data.key;
                document.getElementById('key-modal').classList.add('open');
            } else {
                alert("Failed: " + data.error);
            }
        } catch (e) {
            console.error(e);
            alert("Signature request failed or was rejected.");
        }
    }

    function closeKeyModal() {
        document.getElementById('key-modal').classList.remove('open');
    }

    function copyKey() {
        const key = document.getElementById('generated-key-display').innerText;
        navigator.clipboard.writeText(key);
        alert("API Key copied to clipboard!");
    }

    // ... (Standard Helpers) ...
    async function fetchFees() { try { const res = await fetch(`${API_URL}/api/config/fees`); const data = await res.json(); if (data.success) { feeConfig = data; const solEl = document.getElementById('fee-sol'); const tokEl = document.getElementById('fee-token'); if (solEl) solEl.innerText = `${data.solFee} SOL`; if (tokEl) tokEl.innerText = `${data.tokenFee.toLocaleString()} TOKENS`; } } catch (e) { console.error("Fee fetch failed", e); } }
    function sanitizeInput(str) { if(!str) return ''; const div = document.createElement('div'); div.innerText = str; return div.innerHTML; }
    function openWalletModal() { document.getElementById('wallet-modal').classList.add('open'); isWalletModalOpen = true; }
    function closeWalletModal() { document.getElementById('wallet-modal').classList.remove('open'); isWalletModalOpen = false; }
    async function connectProvider(providerName) { let provider = null; if (providerName === 'phantom' && window.solana && window.solana.isPhantom) provider = window.solana; else if (providerName === 'solflare' && window.solflare) provider = window.solflare; if (!provider) { alert(`${providerName} not found.`); return; } try { const resp = await provider.connect(); walletAddress = resp.publicKey.toString(); walletProvider = provider; closeWalletModal(); updateWalletUI(true); refreshBalances(); } catch (err) { console.error(err); alert("Connection failed."); } }
    function disconnectWallet() { if (walletProvider?.disconnect) walletProvider.disconnect(); walletAddress = null; walletProvider = null; updateWalletUI(false); }
    
    // UPDATED WALLET UI HANDLER
    function updateWalletUI(connected) { 
        const discDiv = document.getElementById('wallet-disconnected'); 
        const connDiv = document.getElementById('wallet-connected'); 
        const submitBtn = document.getElementById('submit-btn'); 
        const displayAddr = document.getElementById('display-address');
        const footerBtn = document.getElementById('footer-connect-btn');
        const footerDisp = document.getElementById('footer-wallet-display');
        
        if (connected) { 
            const shortAddr = walletAddress.slice(0,4) + '...' + walletAddress.slice(-4); 
            if (discDiv) discDiv.classList.add('hidden'); 
            if (connDiv) connDiv.classList.remove('hidden'); 
            if (displayAddr) displayAddr.innerText = shortAddr; 
            if (submitBtn) submitBtn.disabled = false;
            if (footerBtn) footerBtn.classList.add('hidden');
            if (footerDisp) footerDisp.classList.remove('hidden');
            if (footerDisp) footerDisp.classList.add('flex');
        } else { 
            if (discDiv) discDiv.classList.remove('hidden'); 
            if (connDiv) connDiv.classList.add('hidden'); 
            if (submitBtn) submitBtn.disabled = true; 
            if (footerBtn) footerBtn.classList.remove('hidden');
            if (footerDisp) footerDisp.classList.add('hidden');
            if (footerDisp) footerDisp.classList.remove('flex');
        } 
        lucide.createIcons(); 
    }
    
    async function refreshBalances() { if (!walletAddress) return; const icon = document.getElementById('refresh-icon'); if (icon) icon.classList.add('animate-spin'); try { const tokenMint = feeConfig.tokenMint; const res = await fetch(`${API_URL}/api/proxy/balance/${walletAddress}?tokenMint=${tokenMint}`); const data = await res.json(); const solEl = document.getElementById('balance-sol'); const tokEl = document.getElementById('balance-token'); if (data.success) { if(solEl) solEl.innerText = (data.sol || 0).toFixed(4); if(tokEl) tokEl.innerText = (data.tokens || 0).toLocaleString(); } else { if(solEl) solEl.innerText = "Err"; if(tokEl) tokEl.innerText = "Err"; } } catch (e) { console.error("Balance Refresh Failed", e); } finally { if (icon) setTimeout(() => icon.classList.remove('animate-spin'), 500); } }

    async function submitUpdate(e) { 
        e.preventDefault(); 
        if (!walletAddress || !walletProvider) { alert("Please connect wallet first"); return; } 
        const statusDiv = document.getElementById('update-status'); 
        const mint = document.getElementById('update-mint').value; 
        const twitter = document.getElementById('update-twitter').value; 
        const website = document.getElementById('update-website').value; 
        const telegram = document.getElementById('update-telegram').value; 
        const banner = document.getElementById('update-banner').value; 
        const descInput = document.getElementById('update-description'); 
        const description = descInput ? sanitizeInput(descInput.value.substring(0, 250)) : ''; 

        if (banner && !banner.match(/\.(jpeg|jpg|gif|png|webp)$/i)) { 
            statusDiv.innerText = "âŒ Error: Banner URL must end in .jpg, .png, .gif, or .webp"; 
            statusDiv.className = "mt-4 text-center text-sm font-mono text-red-500"; 
            return; 
        } 
        
        statusDiv.innerText = "Fetching Network Data..."; 
        statusDiv.className = "mt-4 text-center text-sm font-mono text-[#ea580c]"; 
        statusDiv.classList.remove('hidden'); 

        try { 
            const bhRes = await fetch(`${API_URL}/api/proxy/blockhash`);
            const bhData = await bhRes.json();
            if(!bhData.success) throw new Error("Failed to get blockhash from backend");
            const blockhash = bhData.blockhash;

            const fromPubkey = new solanaWeb3.PublicKey(walletAddress); 
            const toPubkey = new solanaWeb3.PublicKey(feeConfig.treasury); 
            const tokenMintPubkey = new solanaWeb3.PublicKey(feeConfig.tokenMint); 
            
            const getATA = async (owner, mint) => { 
                const [addr] = await solanaWeb3.PublicKey.findProgramAddress([owner.toBytes(), TOKEN_PROGRAM_ID.toBytes(), mint.toBytes()], ASSOCIATED_TOKEN_PROGRAM_ID); 
                return addr; 
            }; 
            const fromTokenAccount = await getATA(fromPubkey, tokenMintPubkey); 
            const toTokenAccount = await getATA(toPubkey, tokenMintPubkey); 
            
            const transaction = new solanaWeb3.Transaction(); 
            transaction.add(solanaWeb3.SystemProgram.transfer({ fromPubkey, toPubkey, lamports: Math.round(feeConfig.solFee * solanaWeb3.LAMPORTS_PER_SOL) })); 
            
            const decimals = 6; 
            const rawAmount = BigInt(Math.floor(feeConfig.tokenFee * Math.pow(10, decimals))); 
            const dataLayout = new Uint8Array(9); 
            dataLayout[0] = 3; 
            let remaining = rawAmount; 
            for (let i = 0; i < 8; i++) { dataLayout[i + 1] = Number(remaining & 0xFFn); remaining >>= 8n; } 
            
            const transferIx = new solanaWeb3.TransactionInstruction({ 
                keys: [{ pubkey: fromTokenAccount, isSigner: false, isWritable: true }, { pubkey: toTokenAccount, isSigner: false, isWritable: true }, { pubkey: fromPubkey, isSigner: true, isWritable: false }], 
                programId: TOKEN_PROGRAM_ID, 
                data: dataLayout 
            }); 
            transaction.add(transferIx); 
            
            transaction.recentBlockhash = blockhash; 
            transaction.feePayer = fromPubkey; 
            
            statusDiv.innerText = "Please Sign in Wallet..."; 
            
            const signedTx = await walletProvider.signTransaction(transaction); 
            const serialized = signedTx.serialize();
            const base64Tx = window.Buffer.from(serialized).toString('base64');
            
            statusDiv.innerText = "Broadcasting (Premium RPC)...";
            const sendRes = await fetch(`${API_URL}/api/proxy/send-tx`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ signedTx: base64Tx }) });
            const sendData = await sendRes.json();
            if(!sendData.success) throw new Error(sendData.error || "Transaction Failed");
            const signature = sendData.signature;

            statusDiv.innerText = "Verifying Payment..."; 
            const payload = { mint, twitter, website, telegram, banner, description, signature, userPublicKey: walletAddress }; 
            const res = await fetch(`${API_URL}/api/request-update`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) }); 
            const dataRes = await res.json(); 
            
            if (dataRes.success) { 
                statusDiv.innerText = "âœ… Success! Update queued."; 
                statusDiv.className = "mt-4 text-center text-sm font-mono text-green-500"; 
                e.target.reset(); 
                document.getElementById('char-count').innerText = "0"; 
            } else { 
                statusDiv.innerText = `âŒ Verification Failed: ${dataRes.error}`; 
                statusDiv.className = "mt-4 text-center text-sm font-mono text-red-500"; 
            } 
        } catch (err) { 
            console.error(err); 
            statusDiv.innerText = `âŒ Error: ${err.message}`; 
            statusDiv.className = "mt-4 text-center text-sm font-mono text-red-500"; 
        } 
    }

    const formatMoney = (val) => { if (val === undefined || val === null || isNaN(val)) return "$0.00"; return val < 0.01 ? '$' + val.toExponential(2) : '$' + val.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 6 }); };
    const formatCompact = (val) => { if (val === undefined || val === null || isNaN(val)) return "$0"; return '$' + new Intl.NumberFormat('en-US', { notation: "compact", maximumFractionDigits: 1 }).format(val); };
    const formatPct = (val) => { 
        if (val === undefined || val === null || isNaN(val)) return `<span class="text-[#9a3412]">-</span>`; 
        const cls = val > 0 ? 'pill-green' : (val < 0 ? 'pill-red' : 'text-gray-400'); 
        return `<span class="pill ${cls}">${val > 0 ? '+' : ''}${val.toFixed(2)}%</span>`; 
    };
    
    // UPDATED: Age Formatter
    const timeAgo = (ts) => {
        if (!ts) return '';
        const diff = Date.now() - ts;
        const seconds = Math.floor(diff / 1000);
        
        if (seconds < 60) return `${seconds}s ago`;
        if (seconds < 3600) return `${Math.floor(seconds/60)}m ago`;
        if (seconds < 86400) return `${Math.floor(seconds/3600)}h ago`;
        return `${Math.floor(seconds/86400)}d ago`;
    };

    function renderTokenMedia(url, className, fallbackText = '?') { const fallback = `https://placehold.co/80x80/2a1005/7c2d12?text=${fallbackText}`; const safeUrl = url || fallback; const isVideo = safeUrl.match(/\.(mp4|webm|mov)$/i); if (isVideo) { return `<video src="${safeUrl}" class="${className}" autoplay loop muted playsinline poster="${fallback}"></video>`; } return `<img src="${safeUrl}" class="${className}" loading="lazy" onerror="this.onerror=null;this.src='${fallback}'">`; }
    function navigateTo(path) { window.location.hash = path; }
    function handleRoute() { 
        const hash = window.location.hash; 
        document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active')); 
        document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active')); 
        const tableControls = document.getElementById('table-controls'); 
        const detailControls = document.getElementById('detail-controls'); 
        if (tableControls) tableControls.classList.add('hidden'); 
        if (detailControls) detailControls.classList.add('hidden'); 
        
        if (pollingInterval) { clearInterval(pollingInterval); pollingInterval = null; } 
        if (detailPollingInterval) { clearInterval(detailPollingInterval); detailPollingInterval = null; }

        if (hash === '' || hash === '#') { 
            document.getElementById('view-dashboard').classList.add('active'); 
            document.querySelector('button[onclick="navigateTo(\'\')"]').classList.add('active'); 
            if(tableControls) tableControls.classList.remove('hidden'); 
            fetchList(); 
            // Polling for List View (Socket not used for list yet to save bandwidth)
            if (pollingInterval) clearInterval(pollingInterval);
            pollingInterval = setInterval(fetchList, 5000); 
        } else if (hash === '#about') { 
            document.getElementById('view-about').classList.add('active'); 
            document.querySelector('button[onclick="navigateTo(\'about\')"]').classList.add('active'); 
        } else if (hash === '#update') { 
            document.getElementById('view-update').classList.add('active'); 
            document.querySelector('button[onclick="navigateTo(\'update\')"]').classList.add('active'); 
            updateWalletUI(walletAddress !== null); 
        } else if (hash.startsWith('#token/')) { 
            if (pollingInterval) clearInterval(pollingInterval); 
            // Detail view uses socket, no polling interval needed
            showDetailView(hash.split('/')[1]); 
        } 
    }

    async function fetchTokenForUpdate(mint) { if (!mint || mint.length < 30) return; const spinner = document.getElementById('mint-check-spinner'); const infoBox = document.getElementById('token-preview-info'); if(spinner) spinner.classList.remove('hidden'); if(infoBox) infoBox.classList.add('hidden'); try { const res = await fetch(`${API_URL}/api/tokens?search=${mint}&limit=1`); const data = await res.json(); if (data.success && data.tokens.length > 0) { const token = data.tokens[0]; if (token.mint === mint) { currentUpdateTokenData = token; const img = document.getElementById('update-token-img'); const name = document.getElementById('update-token-name'); const tick = document.getElementById('update-token-ticker'); if(img) img.src = token.image || 'https://placehold.co/50'; if(name) name.innerText = token.name; if(tick) tick.innerText = token.ticker; if(infoBox) infoBox.classList.remove('hidden'); } } } catch (e) { console.error("Fetch failed", e); } finally { if(spinner) spinner.classList.add('hidden'); } }
    function openPreview() { if (!currentUpdateTokenData) { alert("Please enter a valid Mint Address first."); return; } const banner = document.getElementById('update-banner').value; const twitter = document.getElementById('update-twitter').value; const website = document.getElementById('update-website').value; const telegram = document.getElementById('update-telegram').value; const t = { ...currentUpdateTokenData, banner, twitter, website, telegram, hasCommunityUpdate: true }; const container = document.getElementById('preview-container'); let html = ''; if (t.banner) { html += `<div class="w-full h-48 md:h-64 rounded-xl border-2 border-[#7c2d12] shadow-lg relative overflow-hidden bg-black mb-6"><img src="${t.banner}" class="w-full h-full object-cover object-center" onerror="this.src='${FALLBACK_BANNER}'"><div class="absolute inset-0 bg-gradient-to-t from-[#2a1005] to-transparent opacity-80 pointer-events-none"></div></div>`; } let linksHtml = ''; if (t.twitter) linksHtml += `<a href="#" class="social-btn"><i data-lucide="twitter" width="20"></i></a>`; if (t.website) linksHtml += `<a href="#" class="social-btn"><i data-lucide="globe" width="20"></i></a>`; if (t.telegram) linksHtml += `<a href="#" class="social-btn"><i data-lucide="send" width="20"></i></a>`; const mediaHtml = renderTokenMedia(t.image, "w-20 h-20 rounded-xl border-2 border-[#ea580c] object-cover bg-black"); html += `<div class="flex flex-col md:flex-row gap-6 mb-8 items-start"><div class="flex items-center gap-6 w-full md:w-auto bg-[#451a03] p-4 rounded-2xl border-2 border-[#7c2d12] shadow-xl">${mediaHtml}<div class="flex-1 min-w-0"><div class="flex flex-col md:flex-row md:items-center gap-2 md:gap-3 mb-1"><h2 class="text-3xl font-bold text-white tracking-tight font-mono">${t.ticker}</h2><span class="text-[#fb923c] text-sm bg-[#2a1005] px-3 py-1 rounded-lg border border-[#7c2d12]">${t.name}</span></div><div class="text-xs text-[#9a3412] font-mono">${t.mint}</div></div></div><div class="flex-1"></div><div class="flex flex-wrap gap-3">${linksHtml}</div></div><div class="text-center text-[#9a3412] font-mono text-xs mt-10">-- End of Preview --</div>`; if(container) container.innerHTML = html; lucide.createIcons(); document.getElementById('preview-modal').classList.add('open'); }
    function closePreview() { document.getElementById('preview-modal').classList.remove('open'); }
    function toggleInfoModal() { const modal = document.getElementById('info-modal'); isInfoModalOpen = !isInfoModalOpen; if (isInfoModalOpen) modal.classList.add('open'); else modal.classList.remove('open'); }
    function toggleVerifiedFilter() { isVerifiedFilter = !isVerifiedFilter; const btn = document.getElementById('filter-verified'); if(btn) { if (isVerifiedFilter) btn.classList.add('active'); else btn.classList.remove('active'); } currentPage = 1; fetchList(); }
    function toggleZeroVolFilter() { isZeroVolHidden = !isZeroVolHidden; const btn = document.getElementById('filter-zerovol'); if(btn) { if (isZeroVolHidden) btn.classList.add('active'); else btn.classList.remove('active'); } currentPage = 1; fetchList(); }
    window.handleSearch = (e) => { searchQuery = e.target.value; const clearBtn = document.getElementById('clear-search-btn'); if (searchQuery.length > 0) { clearBtn.style.display = 'block'; } else { clearBtn.style.display = 'none'; } currentPage = 1; clearTimeout(window.searchTimeout); window.searchTimeout = setTimeout(fetchList, 1000); };
    window.clearSearch = () => { const input = document.getElementById('search'); input.value = ''; searchQuery = ''; document.getElementById('clear-search-btn').style.display = 'none'; currentPage = 1; fetchList(); };
    window.copyMint = () => { const el = document.getElementById('detail-mint'); if(el) navigator.clipboard.writeText(el.innerText); };
    window.handleManualRefresh = () => { fetchList(); };
    window.toggleApiModal = () => { const modal = document.getElementById('api-docs-modal'); isApiModalOpen = !isApiModalOpen; if (isApiModalOpen) modal.classList.add('open'); else modal.classList.remove('open'); }
    window.toggleLpModal = () => { const modal = document.getElementById('lp-modal'); isLpModalOpen = !isLpModalOpen; if (isLpModalOpen) modal.classList.add('open'); else modal.classList.remove('open'); }
    
    // NEW: SET SORT FUNCTION
    window.setSort = (sort) => {
        currentSort = sort;
        currentPage = 1;
        // Update visual sort indicators
        document.querySelectorAll('.sort-header').forEach(th => {
            const onclickVal = th.getAttribute('onclick') || '';
            if (onclickVal.includes(`'${sort}'`)) {
                th.classList.add('text-[#ea580c]', 'border-b-[#ea580c]', 'border-b-2');
            } else {
                th.classList.remove('text-[#ea580c]', 'border-b-[#ea580c]', 'border-b-2');
            }
        });
        fetchList();
    }

    // FETCH LIST
    async function fetchList() { 
        try { 
            const pDisplay = document.getElementById('page-display'); 
            const prev = document.getElementById('btn-prev'); 
            const next = document.getElementById('btn-next'); 
            const dot = document.getElementById('footer-status-dot');
            const txt = document.getElementById('footer-status-text');
            const time = document.getElementById('footer-last-update');

            if(pDisplay) pDisplay.innerText = `Page ${currentPage}`; 
            if(prev) prev.disabled = currentPage <= 1; 
            
            let endpoint = `${API_URL}/api/tokens?sort=${currentSort}&search=${encodeURIComponent(searchQuery)}&limit=100&page=${currentPage}`; 
            if (isVerifiedFilter) endpoint += '&filter=verified'; 
            
            const res = await fetch(endpoint); 
            const data = await res.json(); 
            
            if (data.success) { 
                renderTable(data.tokens); 
                if(next) next.disabled = data.tokens.length < 100; 
                if(dot) { dot.classList.remove('offline'); dot.classList.add('online'); }
                if(txt) txt.innerText = "System Online";
                if(time) time.innerText = new Date().toLocaleTimeString();
            } else {
                if(dot) { dot.classList.add('offline'); dot.classList.remove('online'); }
                if(txt) txt.innerText = "API Error";
            }
        } catch (e) { 
            console.error("API Connection Failed", e); 
            const dot = document.getElementById('footer-status-dot');
            const txt = document.getElementById('footer-status-text');
            if(dot) { dot.classList.add('offline'); dot.classList.remove('online'); }
            if(txt) txt.innerText = "Disconnected";
        } 
    }

    function changePage(delta) { currentPage += delta; if (currentPage < 1) currentPage = 1; if (pollingInterval) clearInterval(pollingInterval); const tbody = document.getElementById('table-body'); if(tbody) tbody.innerHTML = `<tr><td colspan="8" class="text-center py-20 text-orange-700 font-mono animate-pulse">Loading Page ${currentPage}...</td></tr>`; fetchList().then(() => { if (currentPage === 1) { pollingInterval = setInterval(fetchList, 5000); } }); }
    
    function renderTable(tokens) { 
        const tbody = document.getElementById('table-body'); 
        if(!tbody) return; 
        
        let displayTokens = tokens; 
        if (isVerifiedFilter) { displayTokens = displayTokens.filter(t => t.hasCommunityUpdate || t.hascommunityupdate); }
        if (isZeroVolHidden) { displayTokens = displayTokens.filter(t => (t.volume24h || 0) > 0); } 
        
        if (displayTokens.length === 0) { 
            tbody.innerHTML = `<tr><td colspan="8" class="text-center py-20 text-[#9a3412] font-mono">${searchQuery ? `Searching global network for "${searchQuery}"...` : 'No tokens found.'}</td></tr>`; 
            return; 
        } 
        
        tbody.innerHTML = displayTokens.map(t => { 
            const score = t.kScore || t.k_score || 0; 
            const isVerified = t.hasCommunityUpdate || t.hascommunityupdate; 
            const mcap = Number(t.marketCap || t.marketcap || 0); 
            const vol = Number(t.volume24h || 0); 
            const chg1h = t.change1h || 0; 
            const chg5m = t.change5m || 0; 
            const chg24h = t.change24h || 0; 
            
            let kScoreDisplay; 
            if (isVerified) { 
                if (score > 0) { kScoreDisplay = `${score}${score > 50 ? ' ðŸ’Ž' : ''}`; } 
                else { kScoreDisplay = `<span title="Calculating Score..." class="animate-pulse">ðŸ•’</span>`; } 
            } else { 
                kScoreDisplay = '<span title="Community Update Required" class="text-gray-500">ðŸ”’</span>'; 
            } 
            
            const mediaHtml = renderTokenMedia(t.image, "img-token group-hover:border-[#ea580c] transition"); 
            return ` <tr onclick="navigateTo('token/${t.mint}')" class="cursor-pointer group"> <td><div class="flex items-center gap-3">${mediaHtml}<div class="flex flex-col min-w-0"><div class="flex items-center gap-2"><span class="font-bold text-white text-sm group-hover:text-[#ea580c] transition truncate font-sans tracking-wide">${t.ticker}</span>${isVerified ? '<span title="Verified Community Update" class="verified-badge"><i data-lucide="check" width="12"></i></span>' : ''}</div><span class="text-[10px] text-[#9a3412] truncate max-w-[120px] md:max-w-[200px] font-mono group-hover:text-[#fb923c]">${t.name}</span></div></div></td> <td class="text-right text-[#fb923c] font-mono font-bold">${kScoreDisplay}</td> <td class="hidden md:table-cell text-right">${formatPct(chg5m)}</td> <td class="hidden md:table-cell text-right">${formatPct(chg1h)}</td> <td class="text-right">${formatPct(chg24h)}</td> <td class="text-right font-mono text-[#fb923c] font-bold">${formatCompact(mcap)}</td> <td class="hidden md:table-cell text-right font-mono text-[#fb923c]">${(t.holders || 0).toLocaleString()}</td> <td class="text-right font-mono text-[#22c55e]">${formatCompact(vol)}</td> <td class="hidden md:table-cell text-right text-xs text-[#9a3412] font-mono">${timeAgo(t.timestamp)}</td> </tr> `;
        }).join(''); 
        lucide.createIcons(); 
    }

    // SHOW DETAIL VIEW
    async function showDetailView(mint) {
        if (pollingInterval) { clearInterval(pollingInterval); pollingInterval = null; }
        document.getElementById('view-dashboard').classList.remove('active');
        document.getElementById('view-about').classList.remove('active');
        document.getElementById('view-update').classList.remove('active');
        document.getElementById('view-detail').classList.add('active');
        document.getElementById('detail-controls').classList.remove('hidden');

        const loadingDiv = document.getElementById('detail-loading');
        const contentDiv = document.getElementById('detail-content');
        const bannerContainer = document.getElementById('detail-banner-container');
        if(loadingDiv) loadingDiv.style.display = 'block'; 
        if(contentDiv) contentDiv.style.display = 'none'; 
        if(bannerContainer) { bannerContainer.classList.add('hidden'); bannerContainer.innerHTML = ''; }

        // CLEANUP BOTH CHARTS ON SWITCH
        cleanupChart();
        cleanupHolderChart();

        // SUBSCRIBE TO SOCKET ROOM
        if (socket) socket.emit('subscribe', mint);

        const updateDetailUI = async (isInitialLoad = false) => {
            // No need to check document.hidden here since we are socket-driven for updates
            try {
                const res = await fetch(`${API_URL}/api/token/${mint}`);
                const data = await res.json();
                if (data.success) {
                    const t = data.token;
                    
                    if (isInitialLoad) {
                        const tick = document.getElementById('detail-ticker');
                        const nam = document.getElementById('detail-name');
                        const min = document.getElementById('detail-mint');
                        
                        if(tick) tick.innerText = t.ticker;
                        if(nam) nam.innerText = t.name;
                        if(min) min.innerText = t.mint;
                        
                        const rawSupply = parseFloat(t.supply || '0');
                        const decimals = t.decimals || 9;
                        currentNormalizedSupply = rawSupply / Math.pow(10, decimals);
                        if (currentNormalizedSupply === 0) currentNormalizedSupply = 1000000000;

                        const mediaContainer = document.getElementById('detail-media-container');
                        if (mediaContainer) mediaContainer.innerHTML = renderTokenMedia(t.image, "w-20 h-20 rounded-xl border-2 border-[#ea580c] object-cover bg-black shadow-lg");

                        const isVerified = t.hasCommunityUpdate || t.hascommunityupdate;
                        const descEl = document.getElementById('detail-desc');
                        
                        if (t.description && descEl) { descEl.innerHTML = sanitizeInput(t.description); descEl.classList.remove('hidden'); } else if (descEl) { descEl.classList.add('hidden'); }
                        
                        if (t.banner && bannerContainer) {
                            bannerContainer.innerHTML = `<div class="w-full h-48 md:h-64 rounded-xl border-2 border-[#7c2d12] shadow-lg relative overflow-hidden bg-black"><img src="${t.banner}" class="w-full h-full object-cover object-center" onerror="this.src='${FALLBACK_BANNER}'"><div class="absolute inset-0 bg-gradient-to-t from-[#2a1005] to-transparent opacity-80 pointer-events-none"></div></div>`;
                            bannerContainer.classList.remove('hidden');
                        }

                        const actionsDiv = document.getElementById('detail-actions'); 
                        if(actionsDiv) {
                            let linksHtml = `<a href="https://jup.ag/swap?sell=So11111111111111111111111111111111111111112&buy=${t.mint}" target="_blank" class="action-btn flex items-center justify-center gap-2 flex-grow bg-[#191e29] border-[#c7f284] text-[#c7f284] hover:bg-[#c7f284] hover:text-[#000]">Jupiter Swap</a>`;
                            linksHtml += `<a href="https://solscan.io/token/${t.mint}" target="_blank" class="action-btn flex items-center justify-center gap-2 flex-grow"><i data-lucide="search" width="16"></i> Solscan</a>`;
                            if (isVerified) { linksHtml += `<div class="flex items-center px-4 py-2 bg-green-900/30 border border-green-500 text-green-500 rounded-xl font-bold uppercase text-xs tracking-wider h-14"><i data-lucide="shield-check" width="18" class="mr-2"></i> VERIFIED</div>`; }
                            if (t.twitter) linksHtml += `<a href="${t.twitter}" target="_blank" class="social-btn-lg"><i data-lucide="twitter" width="24"></i></a>`;
                            if (t.website) linksHtml += `<a href="${t.website}" target="_blank" class="social-btn-lg"><i data-lucide="globe" width="24"></i></a>`;
                            if (t.telegram) linksHtml += `<a href="${t.telegram}" target="_blank" class="social-btn-lg"><i data-lucide="send" width="24"></i></a>`;
                            actionsDiv.innerHTML = linksHtml; lucide.createIcons();
                        }
                    }

                    // Populate initial stats (live updates handle the rest)
                    updateLiveStats(t);
                    
                    if(t.holderHistory) currentHolderHistory = t.holderHistory;

                    const score = t.kScore || t.k_score || 0;
                    const kEl = document.getElementById('stat-kscore');
                    const isVerified = t.hasCommunityUpdate || t.hascommunityupdate;
                    
                    if (kEl) {
                        if (isVerified) {
                            if (score > 0) { kEl.innerText = score; kEl.classList.remove('text-gray-500'); kEl.classList.add('text-[#fb923c]'); kEl.title = "Conviction Score"; } 
                            else { kEl.innerText = '0'; kEl.classList.remove('text-gray-500'); kEl.classList.add('text-[#fb923c]'); kEl.title = "Score Pending"; }
                        } else { 
                            kEl.innerText = 'ðŸ”’'; kEl.classList.remove('text-[#fb923c]'); kEl.classList.add('text-gray-500'); kEl.title = "Requires Community Update"; 
                        }
                    }

                    // UPDATE POOL LIST
                    currentTokenPairs = t.pairs || [];
                    const lpBody = document.getElementById('lp-list-body');
                    if(lpBody) {
                        lpBody.innerHTML = '';
                        if (currentTokenPairs.length > 0) {
                            let largestPool = currentTokenPairs[0];
                            currentTokenPairs.forEach(p => { if((p.liquidity_usd || 0) > (largestPool.liquidity_usd || 0)) largestPool = p; });

                            if (isInitialLoad) {
                                const dexName = String(largestPool.dex || largestPool.dexId || "Unknown").toUpperCase();
                                const label = document.getElementById('chart-pool-name');
                                if(label) label.innerText = `â€” ${dexName} (Largest Pool)`;
                            }

                            currentTokenPairs.forEach(pair => {
                                const pDex = String(pair.dex || pair.dexId || "Unknown").toUpperCase();
                                const pPrice = formatMoney(pair.price_usd || pair.priceUsd || 0);
                                const pLiq = formatCompact(pair.liquidity_usd || pair.liquidity || 0);
                                const pVol = formatCompact(pair.volume_24h || pair.volume?.h24 || 0);
                                const isMain = pair.address === largestPool.address;
                                const row = document.createElement('tr');
                                row.className = "hover:bg-[#451a03] transition border-b border-[#7c2d12] last:border-0";
                                row.innerHTML = `<td class="px-4 py-3 font-mono font-bold text-[#fb923c]">${pDex} ${isMain ? '<span class="text-[10px] bg-[#ea580c] text-white px-1 rounded ml-1">MAIN</span>' : ''}</td><td class="px-4 py-3 text-right font-mono">${pPrice}</td><td class="px-4 py-3 text-right font-mono text-[#22c55e]">${pLiq}</td><td class="px-4 py-3 text-right font-mono">${pVol}</td><td class="px-4 py-3 text-right"><a href="https://solscan.io/account/${pair.address || pair.pairAddress}" target="_blank" class="text-[#9a3412] hover:text-[#fb923c]"><i data-lucide="external-link" width="14"></i></a></td>`;
                                lpBody.appendChild(row);
                            });
                            lucide.createIcons();
                            if (isInitialLoad) setTimeout(async () => { await fetchCandles(mint); }, 100);
                        } else { lpBody.innerHTML = `<tr><td colspan="5" class="text-center py-4 text-[#9a3412]">No pools found.</td></tr>`; }
                    }

                    if (isInitialLoad) { if(loadingDiv) loadingDiv.style.display = 'none'; if(contentDiv) contentDiv.style.display = 'block'; }
                }
            } catch (e) { console.error(e); if(isInitialLoad && loadingDiv) loadingDiv.innerText = "Error Loading Token Data"; }
        };
        
        await updateDetailUI(true);
        // Polling removed in favor of sockets, but you can re-enable as a fallback if needed
    }
</script>
</body>
</html>
